<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PedalPlex</title>
  <link rel="stylesheet" href="https://unpkg.com/carbon-components/css/carbon-components.min.css" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .pedal-catalog {
      outline: 2px dashed #666;   /* dashed border around the pedal */
      outline-offset: 2px;        /* space between pedal and dashed line */
      position: relative;
    }
    /* dashed overlay */
    .pedal-catalog::after {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: 
        repeating-linear-gradient(
          45deg,
          transparent,
          transparent 4px,
          rgba(0,0,0,0.2) 4px,
          rgba(0,0,0,0.2) 8px
        );
      z-index: 10;
      pointer-events: auto; /* overlay receives events */
    }

    /* Make overlay ignore clicks for the pedal div itself, but block children */
    .pedal-catalog > * {
      pointer-events: none; /* children cannot receive pointer events */
    }
  </style>
</head>
<body>

    <div class="bx--loading-overlay" id="pageLoader" style="display:none;">
      <div class="bx--loading" role="status">
        <svg class="bx--loading__svg" viewBox="-75 -75 150 150">
          <circle class="bx--loading__background" cx="0" cy="0" r="37.5"/>
          <circle class="bx--loading__stroke" cx="0" cy="0" r="37.5"/>
        </svg>
      </div>
    </div>



  <!-- Zoom spinner -->
  <div id="zoomSpinner" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 8px;">
    <div class="bx--loading bx--loading--small" role="alert" aria-live="assertive" aria-label="Loading">
      <svg class="bx--loading__svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        <circle class="bx--loading__background" cx="50" cy="50" r="44" stroke-width="8"></circle>
        <circle class="bx--loading__stroke" cx="50" cy="50" r="44" stroke-width="8"></circle>
      </svg>
    </div>
  </div>
  
  <div id="page-content">

    <div id="pedalAddDropdownContainer"></div>
      <div id="pedalboard-controls" style="display: none; align-items: center; gap: 8px;">
        <select id="pedalboardSelect"></select>
        <button id="renameBoardBtn" class="bx--btn bx--btn--secondary" type="button">Edit
          <svg
            focusable="false"
            preserveAspectRatio="xMidYMid meet"
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            width="16"
            height="16"
            viewBox="0 0 32 32"
            aria-hidden="true"
            class="bx--btn__icon">
            <path d="M3,10V22a2.002,2.002,0,0,0,2,2H27a2.0023,2.0023,0,0,0,2-2V10a2.0027,2.0027,0,0,0-2-2H5A2.0023,2.0023,0,0,0,3,10Zm2,0,2,0V22H5ZM27,22H9V10H27Z"/>
          </svg>   
        </button>   
        <a id="viewPreset" href="preset" class="showDesktop bx--btn bx--btn--primary" type="button">View Presets
          <svg
            focusable="false"
            preserveAspectRatio="xMidYMid meet"
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            width="16"
            height="16"
            viewBox="0 0 32 32"
            aria-hidden="true"
            class="bx--btn__icon">
            <path d="M25,4H10A2.002,2.002,0,0,0,8,6V20.5563A3.9551,3.9551,0,0,0,6,20a4,4,0,1,0,4,4V12H25v8.5562A3.9545,3.9545,0,0,0,23,20a4,4,0,1,0,4,4V6A2.0023,2.0023,0,0,0,25,4ZM6,26a2,2,0,1,1,2-2A2.0023,2.0023,0,0,1,6,26Zm17,0a2,2,0,1,1,2-2A2.0027,2.0027,0,0,1,23,26ZM10,6H25v4H10Z"/>
          </svg>   
        </a>  
      </div>

      <br><br><br><br>

      <div id="pedalboard"></div>


    <!-- Load scripts after content is visible -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="utils.js"></script>
    <script src="pedalboard.js"></script>
    <script src="fullscreen-menu.js"></script>
    <script src="nav-pedalboard.js"></script>
  </div>

    <div class="zoom-controls">  
      <button id="zoomIn" class="bx--btn bx--btn--tertiary bx--btn--sm bx--btn--icon-only" onclick="zoomIn()">
        <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" class="bx--btn__icon">
          <path d="M18 12L14 12 14 8 12 8 12 12 8 12 8 14 12 14 12 18 14 18 14 14 18 14 18 12z"></path><path d="M21.4479,20A10.856,10.856,0,0,0,24,13,11,11,0,1,0,13,24a10.856,10.856,0,0,0,7-2.5521L27.5859,29,29,27.5859ZM13,22a9,9,0,1,1,9-9A9.01,9.01,0,0,1,13,22Z"></path>
        </svg>
      </button>
      <button id="zoomOut" class="bx--btn bx--btn--tertiary bx--btn--sm bx--btn--icon-only" onclick="zoomOut()">
        <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" class="bx--btn__icon">
          <path d="M8 12H18V14H8z"></path><path d="M21.4479,20A10.856,10.856,0,0,0,24,13,11,11,0,1,0,13,24a10.856,10.856,0,0,0,7-2.5521L27.5859,29,29,27.5859ZM13,22a9,9,0,1,1,9-9A9.01,9.01,0,0,1,13,22Z"></path>
        </svg>
      </button>
      <button id="zoomReset" class="bx--btn bx--btn--tertiary bx--btn--sm bx--btn--icon-only" onclick="resetZoom()">
        <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" class="bx--btn__icon">
          <path d="M22.4478,21A10.855,10.855,0,0,0,25,14,10.99,10.99,0,0,0,6,6.4658V2H4v8h8V8H7.332a8.9768,8.9768,0,1,1-2.1,8H3.1912A11.0118,11.0118,0,0,0,14,25a10.855,10.855,0,0,0,7-2.5522L28.5859,30,30,28.5859Z"/>
        </svg>
      </button>
    </div>

  <script src="zoom.js"></script>

  <script>
  // Check user authentication
  $(document).ready(function() {
    if (window.location.protocol === 'file:') {
      alert('Please run this app via a local HTTP server for full functionality.');

      $('#loadingMessage').hide();
      $('#page-content').hide();
      return;
    }

    const token = localStorage.getItem('authToken');
    if (!token) {
      // Guest mode
      $('#loadingMessage').hide();
      $('#page-content').show();

      $('#zoomIn, #zoomOut, #zoomReset').prop('disabled', true).addClass('btn-disabled');

      window.currentUser = { role: 'guest', username: 'guest' };

      if (typeof initNavPedalboard === 'function') initNavPedalboard('guest');
      if (typeof initPedalboard === 'function') initPedalboard('guest');

      return;
    }

    $.ajax({
      url: 'https://www.cineteatrosanluigi.it/plex/USER_CHECK_AUTH_JWT.php',
      method: 'GET',
      dataType: 'json',
      headers: {
        'Authorization': 'Bearer ' + token
      },
      // success: function(userFromServer) {
      //   $('#loadingMessage').hide();
      //   $('#page-content').show();

      //   window.currentUser = userFromServer;

      //   if (typeof initNavPedalboard === 'function') initNavPedalboard(userFromServer.role);
      //   if (typeof initPedalboard === 'function') initPedalboard(userFromServer.role);

      // },
      success: function(userFromServer) {
        $('#loadingMessage').hide();
        $('#page-content').show();
        window.currentUser = userFromServer;

        // 1. Check for guest pedalboards in localStorage
        const guestBoards = localStorage.getItem("guestPedalboard");
        if (guestBoards) {
          const parsed = JSON.parse(guestBoards);
          if (parsed.length > 0) {
            Swal.fire({
              title: "Import Guest Pedalboard?",
              text: "We found pedalboards you created as a guest. Do you want to import them into your account?",
              icon: "question",
              showCancelButton: true,
              confirmButtonText: "Yes, import",
              cancelButtonText: "No, discard",
              customClass: {
                confirmButton: "bx--btn bx--btn--primary",
                cancelButton: "bx--btn bx--btn--secondary",
              }
            }).then((result) => {
              if (result.isConfirmed) {
                // Import sequentially
                const promises = parsed.map(b => importGuestPedalboard(b, userFromServer.id));
                Promise.all(promises)
                  .then(() => {
                    localStorage.removeItem("guestPedalboard");
                    Swal.fire("Imported!", "Your guest pedalboard is now in your account.", "success")
                      .then(() => {
                        if (typeof initNavPedalboard === 'function') initNavPedalboard(userFromServer.role);
                        if (typeof initPedalboard === 'function') initPedalboard(userFromServer.role);
                      });
                  })
                  .catch(err => {
                    Swal.fire("Error", "Guest pedalboard could not be imported.", "error");
                  });
              } else {
                localStorage.removeItem("guestPedalboard"); // discard
              }
            });
            return;
          }
        }

        // 2. Normal initialization if no guest boards
        if (typeof initNavPedalboard === 'function') initNavPedalboard(userFromServer.role);
        if (typeof initPedalboard === 'function') initPedalboard(userFromServer.role);
      },

      error: function(xhr) {
        console.error('Auth check failed:', xhr.status, xhr.responseText);
        if (xhr.status === 401) {
          localStorage.removeItem('authToken');
          window.location.href = 'login';
        } else {
          alert('Failed to verify authentication. Please try again.');
        }
      }
    });
  });
  </script>


</body>
</html>
