<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PedalPlex</title>
  <link rel="icon" href="logos/pedalplex_logo_gradient.png" type="image/x-icon">
  <link rel="stylesheet" href="css/carbon-components.min.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BX9P5WN5HH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BX9P5WN5HH');
  </script>

  <style>
    .pedal-catalog {
      outline: 2px dashed #666;   /* dashed border around the pedal */
      outline-offset: 2px;        /* space between pedal and dashed line */
      position: relative;
    }
    /* dashed overlay */
    .pedal-catalog::after {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: 
        repeating-linear-gradient(
          45deg,
          transparent,
          transparent 4px,
          rgba(0,0,0,0.2) 4px,
          rgba(0,0,0,0.2) 8px
        );
      z-index: 10;
      pointer-events: auto; /* overlay receives events */
    }

    /* Make overlay ignore clicks for the pedal div itself, but block children */
    .pedal-catalog > * {
      pointer-events: none; /* children cannot receive pointer events */
    }

    #pedalboard-controls {
      display: flex !important;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    /* Drag and drop style */
    .dnd-placeholder {
      box-sizing: border-box;
      border: 2px dashed rgba(0,0,0,0.2);
      border-radius: 6px;
      margin: 0 6px;
      background: rgba(0,0,0,0.02);
      flex: 0 0 auto;
    }
    .dnd-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 99999;
      transform: translate(-50%, -50%);
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      opacity: 0.95;
    }
    .pedal-wrapper,
    .pedal-catalog {
      transition: transform 180ms ease, box-shadow 120ms ease;
      will-change: transform;
    }
    .pedal-wrapper.dnd-dragging,
    .pedal-catalog.dnd-dragging {
      opacity: 0.85;
      box-shadow: 0 12px 30px rgba(0,0,0,0.45);
      transform-origin: center center;
    }

    .pedalboard-dnd-placeholder {
      box-sizing: border-box;
      border: 3px dashed rgba(50,50,200,0.7);
      border-radius: 8px;
      background: rgba(50,50,200,0.1);
      margin: 0 8px;
      flex: 0 0 auto;
      transition: height 100ms ease, width 100ms ease;
    }



  </style>
</head>
<body>

    <div class="bx--loading-overlay" id="pageLoader" style="display:none;">
      <div class="bx--loading" role="status">
        <svg class="bx--loading__svg" viewBox="-75 -75 150 150">
          <circle class="bx--loading__background" cx="0" cy="0" r="37.5"/>
          <circle class="bx--loading__stroke" cx="0" cy="0" r="37.5"/>
        </svg>
      </div>
    </div>



  <!-- Zoom spinner -->
  <div id="zoomSpinner" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 8px;">
    <div class="bx--loading bx--loading--small" role="alert" aria-live="assertive" aria-label="Loading">
      <svg class="bx--loading__svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        <circle class="bx--loading__background" cx="50" cy="50" r="44" stroke-width="8"></circle>
        <circle class="bx--loading__stroke" cx="50" cy="50" r="44" stroke-width="8"></circle>
      </svg>
    </div>
  </div>
  
  <div id="page-content">

    <div id="pedalAddDropdownContainer"></div>
      <div id="pedalboard-controls" style="display: none; align-items: center; gap: 8px; width: 100%;">
        <select id="pedalboardSelect"></select>
        <button id="renameBoardBtn" class="bx--btn bx--btn--secondary" type="button">Edit
          <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" class="bx--btn__icon">
            <path d="M3,10V22a2.002,2.002,0,0,0,2,2H27a2.0023,2.0023,0,0,0,2-2V10a2.0027,2.0027,0,0,0-2-2H5A2.0023,2.0023,0,0,0,3,10Zm2,0,2,0V22H5ZM27,22H9V10H27Z"/>
          </svg>   
        </button>   
        <a id="viewPreset" href="plexes" class="showDesktop bx--btn bx--btn--tertiary" type="button" style="margin-left: auto!important;">Go to Plexes
          <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" class="bx--btn__icon">
            <path d="M18 6L16.57 7.393 24.15 15 4 15 4 17 24.15 17 16.57 24.573 18 26 28 16 18 6z"/>
          </svg>   
        </a>  
      </div>

      <br><br><br><br>

      <div id="pedalboard"></div>


    <!-- Load scripts after content is visible -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="utils.js"></script>
    <script src="rigs.js"></script>
    <script src="fullscreen-menu.js"></script>
    <script src="nav-rigs.js"></script>
    <script src="rigs-dnd.js"></script>
    <script src="add-to-rig.js"></script>
    <script src="rigs-pending-add.js"></script>
  </div>

    <div class="zoom-controls"> 
      <!-- Link support PayPal a sinistra -->
      <a href="https://paypal.me/lucacrippa88" target="_blank" id="support" 
        class="bx--btn bx--btn--ghost bx--btn--sm preset-tooltip" type="button" aria-label="Support"
        style="display: flex; align-items: center; gap: 0.5rem; position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #a3a3a3; z-index: 1000; font-weight:normal;">
        <svg focusable="false" preserveAspectRatio="xMidYMid meet xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" class="bx--btn__icon">
          <path d="M13 11H20V13H13z"></path><path d="M29,13H26.98A5.7791,5.7791,0,0,0,25,8.8525V5a1,1,0,0,0-1.6-.8L19.6665,7H15c-5.5095,0-9.4634,3.2412-9.9485,8H5a1.0009,1.0009,0,0,1-1-1V12H2v2a3.0033,3.0033,0,0,0,3,3h.07A9.1733,9.1733,0,0,0,9,23.5566V27a1,1,0,0,0,1,1h4a1,1,0,0,0,1-1V25h3v2a1,1,0,0,0,1,1h4a1,1,0,0,0,1-1V23.6372A5.0928,5.0928,0,0,0,26.8188,20H29a1,1,0,0,0,1-1V14A1,1,0,0,0,29,13Zm-1,5H25.124c-.3052,2.7529-.8235,3.4854-3.124,4.3154V26H20V23H13v3H11V22.3779A7.0129,7.0129,0,0,1,7,16c0-4.8354,4.0181-7,8-7h5.3335L23,7V9.7764c2.4182,1.8593,1.9126,3.186,2.0183,5.2236H28Z"></path><title>Piggy bank slot</title>
        </svg>
        Support
          <!-- Tooltip testo -->
          <span style="left:90%!important;" class="preset-tooltip-text">
            PedalPlex is free and always will be. If you find it useful, you can support hosting and domain costs here.
          </span>
        </a>

      <button id="zoomIn" class="bx--btn bx--btn--tertiary bx--btn--sm bx--btn--icon-only" onclick="zoomIn()">
        <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" class="bx--btn__icon">
          <path d="M18 12L14 12 14 8 12 8 12 12 8 12 8 14 12 14 12 18 14 18 14 14 18 14 18 12z"></path><path d="M21.4479,20A10.856,10.856,0,0,0,24,13,11,11,0,1,0,13,24a10.856,10.856,0,0,0,7-2.5521L27.5859,29,29,27.5859ZM13,22a9,9,0,1,1,9-9A9.01,9.01,0,0,1,13,22Z"></path>
        </svg>
      </button>
      <button id="zoomOut" class="bx--btn bx--btn--tertiary bx--btn--sm bx--btn--icon-only" onclick="zoomOut()">
        <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" class="bx--btn__icon">
          <path d="M8 12H18V14H8z"></path><path d="M21.4479,20A10.856,10.856,0,0,0,24,13,11,11,0,1,0,13,24a10.856,10.856,0,0,0,7-2.5521L27.5859,29,29,27.5859ZM13,22a9,9,0,1,1,9-9A9.01,9.01,0,0,1,13,22Z"></path>
        </svg>
      </button>
      <button id="zoomReset" class="bx--btn bx--btn--tertiary bx--btn--sm bx--btn--icon-only" onclick="resetZoom()">
        <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" class="bx--btn__icon">
          <path d="M22.4478,21A10.855,10.855,0,0,0,25,14,10.99,10.99,0,0,0,6,6.4658V2H4v8h8V8H7.332a8.9768,8.9768,0,1,1-2.1,8H3.1912A11.0118,11.0118,0,0,0,14,25a10.855,10.855,0,0,0,7-2.5522L28.5859,30,30,28.5859Z"/>
        </svg>
      </button>
    </div>

  <script src="zoom.js"></script>


  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const pending = JSON.parse(localStorage.getItem('pendingPedalAdd'));
    if (!pending) return;

    localStorage.removeItem('pendingPedalAdd');

    if (window.pedalboard && window.pedalboard.pedals) {
      window.pedalboard.pedals.push(pending);
      renderPedalboard();
    }
  });
  </script>




  <script>
  $(document).ready(function() {
    if (window.location.protocol === 'file:') {
      alert('Please run this app via a local HTTP server for full functionality.');
      $('#loadingMessage, #page-content').hide();
      return;
    }

    const token = localStorage.getItem('authToken');

    if (!token) {
      // Guest mode
      $('#loadingMessage').hide();
      $('#page-content').show();
      $('#pedalboard-controls').prepend('<p>Login to consistently save your Rigs!</p>');
      $('#pedalboardSelect, #renameBoardBtn').hide();
      $('#zoomIn, #zoomOut, #zoomReset').prop('disabled', true).addClass('btn-disabled');
      window.currentUser = { role: 'guest', username: 'guest' };

      if (typeof initNavPedalboard === 'function') initNavPedalboard('guest');
      if (typeof initPedalboard === 'function') initPedalboard('guest');
      return;
    }

    // Attempt server auth
    $.ajax({
      url: 'https://api.pedalplex.com/USER_CHECK_AUTH_JWT.php',
      method: 'GET',
      dataType: 'json',
      headers: { 'Authorization': 'Bearer ' + token },
      success: function(userFromServer) {
        $('#loadingMessage').hide();
        $('#page-content').show();
        window.currentUser = userFromServer;

        // Recupera eventuali pedalboard guest
        const guestBoardsRaw = localStorage.getItem("guestPedalboard");
        let guestBoards = [];
        if (guestBoardsRaw) {
          try {
            guestBoards = JSON.parse(guestBoardsRaw);
          } catch(e) {
            console.error("Errore parsing guestPedalboard:", e);
            localStorage.removeItem("guestPedalboard");
          }
        }

        if (guestBoards.length > 0) {
          // Prompt per import
          Swal.fire({
            title: "Import last saved Guest Rig?",
            text: "We found a Rig you created as a guest. Do you want to import it into your account?",
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Yes, import",
            cancelButtonText: "No, discard",
            allowOutsideClick: false,
            allowEscapeKey: false,
            customClass: {
              confirmButton: "bx--btn bx--btn--primary",
              cancelButton: "bx--btn bx--btn--secondary"
            }
          }).then((result) => {
            if (result.isConfirmed) {
              const promises = guestBoards.map(b => importGuestPedalboard(b, userFromServer.id));
              Promise.all(promises)
                .then(() => {
                  localStorage.removeItem("guestPedalboard");
                  Swal.fire({
                    title: "Imported!",
                    text: "Your guest Rig is now in your account.",
                    icon: "success",
                    confirmButtonText: "Ok",
                    showCancelButton: false,
                    customClass: { confirmButton: "bx--btn bx--btn--primary" }
                  }).finally(() => {
                    if (typeof initNavPedalboard === 'function') initNavPedalboard(userFromServer.role);
                    if (typeof initPedalboard === 'function') initPedalboard(userFromServer.role);
                  });
                })
                .catch(err => {
                  console.error(err);
                  Swal.fire("Error", "Guest pedalboard could not be imported.", "error")
                    .finally(() => {
                      if (typeof initNavPedalboard === 'function') initNavPedalboard(userFromServer.role);
                      if (typeof initPedalboard === 'function') initPedalboard(userFromServer.role);
                    });
                });
            } else {
              localStorage.removeItem("guestPedalboard");
              if (typeof initNavPedalboard === 'function') initNavPedalboard(userFromServer.role);
              if (typeof initPedalboard === 'function') initPedalboard(userFromServer.role);
            }
          });
        } else {
          if (typeof initNavPedalboard === 'function') initNavPedalboard(userFromServer.role);
          if (typeof initPedalboard === 'function') initPedalboard(userFromServer.role);
        }
      },

      // ---------- TOKEN EXPIRED (401) ----------
      error: function(xhr) {
        console.error('Auth check failed:', xhr.status, xhr.responseText);

        if (xhr.status === 401) {
          localStorage.removeItem('authToken');

          Swal.fire({
            title: 'Session expired',
            text: 'Your session is expired. Do you want to Login again or continue as a Guest?',
            icon: 'warning',
            showDenyButton: true,
            confirmButtonText: 'Login',
            denyButtonText: 'Be our Guest',
            customClass: {
              confirmButton: 'bx--btn bx--btn--primary',
              denyButton: 'bx--btn bx--btn--tertiary'
            },
            allowOutsideClick: false,
            allowEscapeKey: false
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = 'login';
            } else if (result.isDenied) {

              // Guest mode fallback
              window.currentUser = { role: 'guest', username: 'guest' };
              $('#loadingMessage').hide();
              $('#page-content').show();
              $('#pedalboard-controls').append("<p>Login to consistently save your Rigs!</p>");
              $('#pedalboardSelect, #renameBoardBtn').hide();
              $('#zoomIn, #zoomOut, #zoomReset').prop('disabled', true).addClass('btn-disabled');

              if (typeof initNavPedalboard === 'function') initNavPedalboard('guest');
              if (typeof initPedalboard === 'function') initPedalboard('guest');
            }
          });

        } else {
          alert('Failed to verify authentication. Please try again.');
        }
      }
    });
  });
  </script>



</body>
</html>
