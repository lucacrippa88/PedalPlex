<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Pedal Builder</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/carbon-components/css/carbon-components.min.css" />
    <link rel="stylesheet" href="style.css">
    <script src="utils.js"></script>
    <script src="create.js"></script>
    <style>

        /* Make the builder container a flex layout */
        #builder {
        display: flex;
        align-items: flex-start;
        }

        /* Editor takes the left side and can scroll */
        #editor {
        flex: 1;
        padding: 20px;
        max-width: 60%;
        }

        /* Preview stays fixed on the right */
        #preview {
        position: fixed;
        right: 20px;
        top: 20px;
        bottom: 20px;
        /* width: 55%; */
        overflow: auto;
        padding: 15px;
        border-radius: 8px;
        }

        body { /* Da capire come integrare nelle altre pagine */
            margin: 0;
            padding-right: 40%; /* reserve space for preview */
        }


    </style>
</head>

<body>

    <div id="builder">

        <div id="editor">
            <div class="pedal-info">

                <label for="pedal-author">Author:</label>
                <span id="pedal-author"></span>

                <input type="hidden" id="pedal-author-id" />

                <label for="pedal-published">Status</label>
                <select id="pedal-published">
                    <option value="draft">Draft</option>
                    <option value="private">Private</option>
                    <option value="reviewing">Reviewing</option>
                    <option value="public">Public</option>
                </select>

                <label>ID <input type="text" class="create-gear-input" id="pedal-id" placeholder="Insert unique gear ID..."></label>
                <label>Name <input type="text" class="create-gear-input" id="pedal-name" placeholder="Insert gear name..."></label>
                <label>Logo style <input type="text" class="create-gear-input" id="pedal-logo" placeholder="Set valid CSS..."></label>
            </div>
            <br>
            <div class="form-group">
                <label for="pedal-author">Author</label>
                <input type="text" id="pedal-author" class="form-control" readonly>
            </div>
            <br>
            <label>Type <select id="pedal-type">
                    <option value="pedal">Pedal</option>
                    <option value="pedal-inverted">Pedal Inverted</option>
                    <option value="expression">Expression</option>
                    <option value="combo">Combo</option>
                    <option value="head">Head</option>
                    <option value="round">Round</option>
                </select>
                </label>
                <label>Width <select id="pedal-width"></select></label>
                <label>Height <select id="pedal-height"></select></label>
                <br><br>
                <label>Color <input type="color" id="pedal-color" value="#264985"></label>&ensp;&ensp;
                <label>Font Color <input type="color" id="font-color" value="#ffffff"></label>&ensp;&ensp;
                <br><br>
                <label>Inside color type <select id="inside-type-select">
                    <option value="color">Color</option>
                    <option value="image">Image</option>
                </select>
                </label>&ensp;&ensp;
                
                <label id="inside-color-label">Inside Color<input type="color" id="pedal-inside-color" value="#0d0d0d"></label>
                <label id="inside-image-label" style="display:none">Image URL<input type="text" id="pedal-inside-image" placeholder="https://example.com/image.png"></label>
                <label id="pedal-inside-full-check-label"><input type="checkbox" id="pedal-inside-full-check"> Full</label>

                
                <label id="inside-border-label" style="display:none;"> Inside Border <input type="checkbox" id="pedal-inside-border-check"><input type="color" id="pedal-inside-border" value="#000000"></label>
                <br><br>
                <label>Knobs Color <input type="color" id="knobs-color" value="#191919"></label>&ensp;&ensp;
                <label>Knobs Border <input type="color" id="knobs-border" value="#424242"></label>&ensp;&ensp;
                <label>Knobs Indicator <input type="color" id="knobs-indicator" value="#ffffff"></label>&ensp;&ensp;
                <script>
                $("#pedal-inside-full-check").on("change", function () {
                    const isImage = $("#inside-type-select").val() === "image";
                    $("#inside-border-label").toggle(this.checked || isImage);
                });

                // Also update border visibility when inside type changes
                $("#inside-type-select").on("change", function () {
                    const isImage = $(this).val() === "image";
                    const isFull = $("#pedal-inside-full-check").is(":checked");
                    $("#inside-border-label").toggle(isFull || isImage);

                    if ($(this).val() === "color") {
                        $("#inside-color-label").show();
                        $("#inside-image-label").hide();
                        $("#pedal-inside-full-check-label").show();
                    } else {
                        $("#inside-color-label").hide();
                        $("#inside-image-label").show();
                        $("#pedal-inside-full-check-label").hide();
                    }
                });
                </script>

                <br><br>
                
                <div id="json-error" style="color:red; font-weight:bold; margin-top:5px;"></div>

                <br><br><br><hr></br><br>
                
                <button class="bx--btn bx--btn--sm bx--btn--primary" id="add-row">+ Add Control Row</button><br><br>
                <div id="controls"></div>
        </div>


        <!-- Pedal preview -->
        <div id="preview">

            <button class="bx--btn bx--btn--sm bx--btn--secondary" id="toggle-preview" style="color:white;">
                <svg fill="white" class="icon-eye" xmlns="http://www.w3.org/2000/svg" 
                    viewBox="0 0 32 32" width="16" height="16" aria-hidden="true" focusable="false" 
                    style="margin-right:4px; vertical-align:middle;">
                    <path d="M28.28,27.71l-22-22L4.86,7.14,7.6,9.88A16.44,16.44,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27a15.89,15.89,0,0,0,7.12-1.69l3,3Zm-8.45-8.45,1.6,1.6A7,7,0,0,1,16,23c-5.3,0-10.9-3.93-12.93-9A14.63,14.63,0,0,1,9.6,11.41l1.69,1.69A7,7,0,0,0,16,21,6.93,6.93,0,0,0,19.83,19.26Z"/>
                </svg>
                Hide Preview
            </button>
            <br><br>

            <script>
                const eyeIcon = `<path d="M30.94,15.66A16.69,16.69,0,0,0,16,5,16.69,16.69,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27,16.69,16.69,0,0,0,30.94,16.34,1,1,0,0,0,30.94,15.66ZM16,25c-5.3,0-10.9-3.93-12.93-9C5.1,10.93,10.7,7,16,7s10.9,3.93,12.93,9C26.9,21.07,21.3,25,16,25Z"/><path d="M16,10a6,6,0,1,0,6,6A6,6,0,0,0,16,10Zm0,10a4,4,0,1,1,4-4A4,4,0,0,1,16,20Z"/>`;
                const eyeOffIcon = `<path d="M28.28,27.71l-22-22L4.86,7.14,7.6,9.88A16.44,16.44,0,0,0,1.06,15.66a1,1,0,0,0,0,.68A16.69,16.69,0,0,0,16,27a15.89,15.89,0,0,0,7.12-1.69l3,3Zm-8.45-8.45,1.6,1.6A7,7,0,0,1,16,23c-5.3,0-10.9-3.93-12.93-9A14.63,14.63,0,0,1,9.6,11.41l1.69,1.69A7,7,0,0,0,16,21,6.93,6.93,0,0,0,19.83,19.26Z"/>`;

                $("#toggle-preview").on("click", function() {
                    $("#pedal-box").toggle();
                    const isVisible = $("#pedal-box").is(":visible");

                    const svg = $(this).find("svg");
                    svg.html(isVisible ? eyeOffIcon : eyeIcon); // eye-off when visible, eye when hidden

                    $(this).contents().filter(function() {
                    return this.nodeType === 3; // text node
                    }).remove();
                    $(this).append(isVisible ? " Hide Preview" : " Show Preview");
                });
            </script>

        <div id="pedal-box"></div>

        </div>
    </div>

    <!-- JSON (to be removed) -->
    <!-- <h2>Generated JSON</h2><br><br> -->
    <textarea id="json-output" style="width:100%;height:300px;font-family:monospace;"></textarea>
   


    <!-- Templates -->
    <script type="text/template" id="knob-template">
        <div class="control" data-type="knob">
        <h4>Knob</h4>
        <label>Label <input type="text" class="ctrl-label"></label>
        <label>Knob Type</label>
            <select class="ctrl-knob-type">
                <option value="numeric">Numeric</option>
                <option value="discrete">Discrete</option>
            </select>
        <label>Size <select class="ctrl-size">
            <option value="knob" selected>Regular</option>
            <option value="smallknob">Small</option>
            <option value="largeknob">Large</option>
            <option value="xlargeknob">XLarge</option>
            </select>
        </label>
        <!-- <label>Position 
            <select class="ctrl-position">
            <option></option>
            <option>highest</option>
            <option>higher</option>
            <option>high</option>
            <option>low</option>
            <option>lower</option>
            <option>lowest</option>
            <option>under-top</option>
            <option>align-top</option>
            <option>align-top-clear</option>
            <option>align-top-clearer</option>
            <option value="margin-left">Margin Left</option>
            <option value="margin-right">Margin Right</option>
            </select>
        </label>
        <input type="number" class="ctrl-position-value" placeholder="px" min="0" style="display:none; width:50px;"> -->


        <label>Position
        <select class="ctrl-position-keyword">
            <option></option>
            <option>highest</option>
            <option>higher</option>
            <option>high</option>
            <option>low</option>
            <option>lower</option>
            <option>lowest</option>
            <option>under-top</option>
            <option>align-top</option>
            <option>align-top-clear</option>
            <option>align-top-clearer</option>
        </select>
        </label>

        <label>Margin
        <select class="ctrl-position-margin">
            <option value="">None</option>
            <option value="margin-left">Margin Left</option>
            <option value="margin-right">Margin Right</option>
        </select>
        </label>
        <input type="number" class="ctrl-position-margin-value" placeholder="px" min="0" style="display:none; width:50px;">



        <label>
            <input type="checkbox" class="ctrl-knob-color-enable"> Knob
            <input type="color" class="ctrl-knob-color" disabled>
        </label>
        <label>
            <input type="checkbox" class="ctrl-knob-border-enable"> Border
            <input type="color" class="ctrl-knob-border" disabled>
        </label>
        <label>
            <input type="checkbox" class="ctrl-knob-indicator-enable"> Indicator
            <input type="color" class="ctrl-knob-indicator" disabled>
        </label>
        <label>
            <input type="checkbox" class="ctrl-knob-thick"> Thick Border
        </label>
        <span class="numeric-fields">
            <label>Min <input type="number" class="ctrl-num ctrl-min" value="7"></label>
            <label>Max <input type="number" class="ctrl-num ctrl-max" value="17"></label>
            <label>Val <input type="number" class="ctrl-num ctrl-value" value="12"></label>
        </span>
        <span class="discrete-fields" style="display:none;">
            <label>Values <input type="text" class="ctrl-values-list" placeholder="A,B,C"></label>
            <label>Current Value <select class="ctrl-value-select"></select></label>
        </span>
        <label>Span
            <select class="ctrl-span">
                <option value="all">12am->12pm</option>
                <option value="three-quarters" selected>7am->5pm</option>
                <option value="half">6am->12pm</option>
                <option value="half-shift">2am<-8pm</option>
                <option value="half-shift-inverted">5pm->11pm</option>
                <option value="quarter">1am->10am</option>
                <option value="tenToTwo">10am->2pm</option>
            </select>
        </label>



        <br>
        <div class="ctrl-actions">
            <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
            <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
            <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
        </div>
        </div>
        </script>

    <script type="text/template" id="led-template">
        <div class="control" data-type="led">
  <h4>LED</h4>
  <label>Label <input type="text" class="ctrl-label"><input type="checkbox" class="ctrl-showlabel"></label>
        <label>Position 
            <select class="ctrl-position">
            <option></option>
            <option>highest</option>
            <option>higher</option>
            <option>high</option>
            <option>low</option>
            <option>lower</option>
            <option>lowest</option>
            <option>xlow</option>
            <option>right</option>
            <option>under-top</option>
            <option>align-top</option>
            <option value="margin-left">Margin Left</option>
            <option value="margin-right">Margin Right</option>
            </select>
        </label>
        <input type="number" class="ctrl-position-value" placeholder="px" min="0" style="display:none; width:50px;">

    <div class="led-colors-container">
      <label>Color 0 <input type="color" class="ctrl-color" value="#000000"></label>
      <label>Color 1 <input type="color" class="ctrl-color" value="#ff0000"></label>
    </div>
    <button class="bx--btn bx--btn--sm bx--btn--tertiary add-led-color">+ Color</button>
    <select class="ctrl-value"></select>

  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>



<script>
// Function to add a new LED control
function addLedControl() {
    const tpl = $("#led-template").html();
    const $ctrl = $(tpl);

    // Append to #controls
    $("#controls").append($ctrl);

    // Immediately populate the dropdown
    updateLedValueSelect($ctrl);
}

// Add a new color to existing LED
$("#controls").on("click", ".add-led-color", function() {
    const $ctrl = $(this).closest(".control");

    // Next color index
    const nextIndex = $ctrl.find(".led-colors-container .ctrl-color").length;

    // Add new color input
    const $newColor = $(`
        <label>Color ${nextIndex} 
            <input type="color" class="ctrl-color" value="#ffffff">
        </label>
    `);
    $ctrl.find(".led-colors-container").append($newColor);

    // Update dropdown
    updateLedValueSelect($ctrl);

    // Immediately update JSON
    buildJSON();
});

// Populate the value dropdown based on current colors
function updateLedValueSelect($ctrl) {
    const $select = $ctrl.find(".ctrl-value");
    $select.empty();

    $ctrl.find(".led-colors-container .ctrl-color").each((i) => {
        $select.append(`<option value="${i}">${i}</option>`);
    });

    // Default selection to 0 if nothing selected
    const prev = parseInt($select.data("prev"));
    const maxVal = $ctrl.find(".ctrl-color").length - 1;
    const newVal = (!isNaN(prev) && prev <= maxVal) ? prev : 0;
    $select.val(newVal);
    $select.data("prev", newVal);
}

// Sync value select on change
$("#controls").on("change", ".ctrl-value", function() {
    $(this).data("prev", $(this).val());
});

// Refresh dropdown when a color input changes
$("#controls").on("input", ".ctrl-color", function() {
    const $ctrl = $(this).closest(".control");
    updateLedValueSelect($ctrl);
});

// Example: attach LED creation to button
$("#add-led").on("click", addLedControl);
</script>


    <script type="text/template" id="slider-template">
        <div class="control" data-type="slider">
  <h4>Slider</h4>
  <label>Label <input type="text" class="ctrl-label"></label>
  <label>Orientation <select class="ctrl-orientation"><option selected>vertical</option><option>vertical small</option><option>horizontal</option></select></label>
  <label>Min <input type="number" class="ctrl-num ctrl-min" value="-15"></label>
  <label>Max <input type="number" class="ctrl-num ctrl-max" value="15"></label>
  <label>Value <input type="number" class="ctrl-num ctrl-value" value="0"></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script type="text/template" id="lcd-template">
        <div class="control" data-type="lcd">
  <h4>LCD</h4>
  <label>Label <input type="text" class="ctrl-label"></label>
<label>Position 
            <select class="ctrl-position">
            <option></option>
            <option>higher</option>
            <option>high</option>
            <option>lower</option>
            </select>
        </label>
    <label>Width <input type="text" class="ctrl-width" value=30></label>
  <label>Height <input type="text" class="ctrl-height" value=10></label>
  <label>Round? <input type="checkbox" class="ctrl-round"></label>
  <label>Screen <input type="color" class="ctrl-screen1" value="#111111"></label>
  <label>Color <input type="color" class="ctrl-screen2" value="#ff0000"></label>
  <label>Text <input type="text" class="ctrl-text" value="LCD"></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script type="text/template" id="multi-template">
        <div class="control" data-type="multi">
  <h4>Multi Select</h4>
  <label>Label <input type="text" class="ctrl-label"><input type="checkbox" class="ctrl-showlabel"></label>
  <label>Position 
            <select class="ctrl-position">
            <option></option>
            <option>highest</option>
            <option>higher</option>
            <option>lower</option>
            <option>right</option>
            <option>left</option>
            <option>align-top</option>
            <option value="margin-left">Margin Left</option>
            <option value="margin-right">Margin Right</option>
            </select>
        </label>
        <input type="number" class="ctrl-position-value" placeholder="px" min="0" style="display:none; width:50px;">
    <label>Values <input type="text" class="ctrl-values" value="A,B,C"></label>
  <label>Selected <input type="text" class="ctrl-num ctrl-value" value="A"></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script>
        const widths = ["xsmall", "smaller", "small", "medium", "standard", "large", "+large", "larger", "+larger", "++larger", "xlarge",
            "xlarger", "largest", "wide", "wider", "widest", "xwidest"];
        const heights = ["xsmall", "smaller", "small", "medium", "standard", "large", "+large", "larger", "xlarge",
            "xlarger", "largest", "xlargest", "tall"];



        // Disable/enable LCD Height when Round is checked
        $("#controls").on("change", ".ctrl-round", function() {
            const $ctrl = $(this).closest(".control");
            const isRound = $(this).is(":checked");
            $ctrl.find(".ctrl-height").prop("disabled", isRound);
        });

        // Show/hide margin input
        // Only for knobs
        $("#controls").on("change", ".ctrl-position-margin", function() {
            const $ctrl = $(this).closest(".control");
            const val = $(this).val();
            $ctrl.find(".ctrl-position-margin-value").toggle(val !== "");
        });


        // Show numeric input only for margin-left / margin-right
        $("#controls").on("change", ".ctrl-position", function () {
            const val = $(this).val();
            const $numInput = $(this).closest("label").next(".ctrl-position-value");
            if (val === "margin-left" || val === "margin-right") {
                $numInput.show();
            } else {
                $numInput.hide().val("");
            }
            buildJSON();
        });


        // Switch between inner color or image
        $("#inside-type-select").on("change", function() {
        const type = $(this).val();
        if (type === "color") {
            $("#inside-color-label").show();
            $("#inside-image-label").hide();
            $("#pedal-inside-full-check").show();
        } else {
            $("#inside-color-label").hide();
            $("#inside-image-label").show();
            $("#pedal-inside-full-check").hide();
            $("#pedal-inside-full-check-label").hide();
        }
        });



        // Enable/disable knob color inputs
        $("#controls").on("change", ".ctrl-knob-color-enable", function () {
            $(this).siblings(".ctrl-knob-color").prop("disabled", !this.checked);
            buildJSON();
        });
        $("#controls").on("change", ".ctrl-knob-border-enable", function () {
            $(this).siblings(".ctrl-knob-border").prop("disabled", !this.checked);
            buildJSON();
        });
        $("#controls").on("change", ".ctrl-knob-indicator-enable", function () {
            $(this).siblings(".ctrl-knob-indicator").prop("disabled", !this.checked);
            buildJSON();
        });

        // Select knob type
        $(document).on("change", ".ctrl-knob-type", function () {
            const $ctrl = $(this).closest(".control");

            if ($(this).val() === "numeric") {
                $ctrl.find(".numeric-fields").show();
                $ctrl.find(".discrete-fields").hide();
            } else {
                $ctrl.find(".numeric-fields").hide();
                $ctrl.find(".discrete-fields").show();
            }
        });



        let isSyncing = false;



        $(function () {
            widths.forEach(w => $("#pedal-width").append(`<option>${w}</option>`));
            heights.forEach(h => $("#pedal-height").append(`<option>${h}</option>`));
            $("#pedal-width").val("standard");
            $("#pedal-height").val("standard");

            // Add control row
            $("#add-row").on("click", function () {
                const row = $(`
                    <div class="row" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                        <div class="row-buttons" style="display:flex; gap:10px;">
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-knob">+ Knob</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-led">+ LED</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-slider">+ Slider</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-lcd">+ LCD</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-multi">+ Multi</button>
                        </div>
                        <div class="controls-row" style="display:flex; gap:10px; flex-wrap:nowrap;"></div>
                        <div class="row-actions" style="display:flex; gap:6px; flex-wrap:nowrap;">
                        <button class="bx--btn bx--btn--sm bx--btn--secondary row-up">↑ Row</button><br>
                        <button class="bx--btn bx--btn--sm bx--btn--secondary row-down">↓ Row</button><br>
                        <button class="bx--btn bx--btn--sm bx--btn--danger row-remove">✕ Remove Row</button>
                        </div>
                        <hr style="width:50%; position:relative; left:-33px;"><br>
                    </div>
                    `);
                $("#controls").append(row);
                buildJSON();
            });

            function addControl(buttonClass, templateId) {
                $("#controls").on("click", buttonClass, function () {
                    const controlsRow = $(this).closest(".row").find(".controls-row");
                    const $ctrl = $(templateId).html();
                    controlsRow.append($ctrl);

                    // If this is an LED, immediately populate its dropdown
                    if ($(templateId).attr("id") === "led-template") {
                        updateLedValueSelect(controlsRow.find(".control[data-type=led]").last());
                    }

                    buildJSON();
                });
            }

            addControl(".add-knob", "#knob-template");
            addControl(".add-led", "#led-template");
            addControl(".add-slider", "#slider-template");
            addControl(".add-lcd", "#lcd-template");
            addControl(".add-multi", "#multi-template");

            // Move/remove controls
            $("#controls").on("click", ".remove", function () {
                $(this).closest(".control").remove();
                buildJSON();
            });
            $("#controls").on("click", ".move-up", function () {
                const c = $(this).closest(".control");
                c.prev(".control").before(c);
                buildJSON();
            });
            $("#controls").on("click", ".move-down", function () {
                const c = $(this).closest(".control");
                c.next(".control").after(c);
                buildJSON();
            });

            // Row actions
            $("#controls").on("click", ".row-remove", function () {
                $(this).closest(".row").remove();
                buildJSON();
            });
            $("#controls").on("click", ".row-up", function () {
                const r = $(this).closest(".row");
                r.prev(".row").before(r);
                buildJSON();
            });
            $("#controls").on("click", ".row-down", function () {
                const r = $(this).closest(".row");
                r.next(".row").after(r);
                buildJSON();
            });

            $("#editor, #controls").on("input change keyup", "input, select, textarea", buildJSON);
            buildJSON();
        });


    // Sync values list to select options for knobs
    $("#controls").on("input", ".ctrl-values-list", function() {
        const $row = $(this).closest(".control");
        const values = $(this).val().split(",").map(v => v.trim()).filter(v => v);
        const $select = $row.find(".ctrl-value-select");
        $select.empty();
        values.forEach(v => $select.append(`<option>${v}</option>`));
        buildJSON();
    });

    $("#json-output").on("input", function () {
        const $err = $("#json-error");
        try {
            const parsed = JSON.parse($(this).val());
            $err.text(""); // clear error if valid
            syncUIFromJSON(parsed);
        } catch (e) {
            $err.text("Invalid JSON: " + e.message);
        }
    });
    </script>



<script>
$("#editor, #controls").on("input change keyup", "input, select, textarea", function() {
    buildJSON(); // triggers safe stringify and sends to parent
});
</script>


</body>

</html>