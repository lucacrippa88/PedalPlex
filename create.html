<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Pedal Builder</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/carbon-components/css/carbon-components.min.css" />
    <link rel="stylesheet" href="style.css">
    <script src="utils.js"></script>
    <style>

    </style>
</head>

<body>

    <center>
        <h2>Gear Preview</h2><br><br>
        <div id="pedal-box"></div>
    </center>

    <br><br>

    <div id="builder">

        <div id="editor">
            <h2>Gear Quick Creation</h2><br><br>
            <div class="pedal-info">
                <label>ID <input type="text" id="pedal-id" placeholder="Insert unique gear ID..."></label>
                <label>Name <input type="text" id="pedal-name" placeholder="Insert gear name..."></label>
                <label>Logo style <input type="text" id="pedal-logo" placeholder="Set valid CSS..."></label>
            </div>
            <br>
            <label>Type <select id="pedal-type">
                    <option value="pedal">Pedal</option>
                    <option value="pedal-inverted">Pedal Inverted</option>
                    <option value="expression">Expression</option>
                    <option value="combo">Combo</option>
                    <option value="head">Head</option>
                    <option value="round">Round</option>
                </select>
                <label>Width <select id="pedal-width"></select></label>
                <label>Height <select id="pedal-height"></select></label>
                <br><br>
                <label>Color <input type="color" id="pedal-color" value="#264985"></label>&ensp;&ensp;
                <label>Font Color <input type="color" id="font-color" value="#ffffff"></label>&ensp;&ensp;
                <label> Inside Color (Full <input type="checkbox" id="pedal-inside-full-check">)</label><input
                    type="color" id="pedal-inside-color" value="#0d0d0d">&ensp;&ensp;
                <label id="inside-border-label" style="display:none;"> Inside Border <input type="checkbox"
                        id="pedal-inside-border-check"><input type="color" id="pedal-inside-border"
                        value="#ffffff"></label>

                <script>
                    $("#pedal-inside-full-check").on("change", function () {
                        $("#inside-border-label").toggle(this.checked);
                    });
                </script>

                <hr>
                <button class="bx--btn bx--btn--sm bx--btn--primary" id="add-row">+ Add Control Row</button>
                <div id="controls"></div>
        </div>



        <div id="preview">
            <h2>Generated JSON</h2><br><br>
            <textarea id="json-output" style="width:100%;height:300px;font-family:monospace;"></textarea>
            <div id="json-error" style="color:red; font-weight:bold; margin-top:5px;"></div>
        </div>
    </div>






    <!-- Templates -->
    <script type="text/template" id="knob-template">
        <div class="control" data-type="knob">
        <h4>Knob</h4>
        <label>Label <input type="text" class="ctrl-label"></label>
        <label>Size <select class="ctrl-size">
            <option value="knob" selected>Regular</option>
            <option value="smallknob">Small</option>
            <option value="largeknob">Large</option>
            <option value="xlargeknob">XLarge</option>
            </select>
        </label>
        <!-- <label>Position <select class="ctrl-position"><option>highest</option><option>higher</option><option>high</option><option selected></option><option>low</option><option>lower</option><option>lowest</option><option>align-top</option><option>under-top</option></select></label> -->
        <label>Position 
            <select class="ctrl-position">
            <option></option>
            <option>highest</option>
            <option>higher</option>
            <option>high</option>
            <option>low</option>
            <option>lower</option>
            <option>lowest</option>
            <option>under-top</option>
            <option>align-top</option>
            <option>align-top-clear</option>
            <option>align-top-clearer</option>
            <option value="margin-left">Margin Left</option>
            <option value="margin-right">Margin Right</option>
            </select>
        </label>
        <input type="number" class="ctrl-position-value" placeholder="px" min="0" style="display:none; width:80px;">
        <label>Knob <input type="color" class="ctrl-knob-color" value=""></label>
        <label>Border <input type="color" class="ctrl-knob-border" value=""></label>
        <label>Indicator <input type="color" class="ctrl-knob-indicator" value=""></label>
        <label>Min <input type="number" class="ctrl-num ctrl-min" value="7"></label>
        <label>Max <input type="number" class="ctrl-num ctrl-max" value="17"></label>
        <label>Val <input type="number" class="ctrl-num ctrl-value" value="12"></label>
        <br>
        <div class="ctrl-actions">
            <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
            <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
            <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
        </div>
        </div>
        </script>

    <script type="text/template" id="led-template">
        <div class="control" data-type="led">
  <h4>LED</h4>
  <label>Label <input type="text" class="ctrl-label"></label>
  <label>Position <select class="ctrl-position"><option>highest</option><option>higher</option><option>high</option><option selected></option><option>low</option><option>lower</option><option>lowest</option><option>xlow</option><option>right</option><option>under-top</option><option>align-top</option><option>align-top-clear</option><option>align-top-clearer</option></select></label>
  <label>Color OFF <input type="color" class="ctrl-color0" value="#000000"></label>
  <label>Color ON <input type="color" class="ctrl-color1" value="#f70000"></label>
  <label>Value <select class="ctrl-value"><option value="0">Off</option><option value="1">On</option></select></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script type="text/template" id="slider-template">
        <div class="control" data-type="slider">
  <h4>Slider</h4>
  <label>Label <input type="text" class="ctrl-label"></label>
  <label>Orientation <select class="ctrl-orientation"><option selected>vertical</option><option>vertical small</option><option>horizontal</option></select></label>
  <label>Min <input type="number" class="ctrl-num ctrl-min" value="-15"></label>
  <label>Max <input type="number" class="ctrl-num ctrl-max" value="15"></label>
  <label>Value <input type="number" class="ctrl-num ctrl-value" value="0"></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script type="text/template" id="lcd-template">
        <div class="control" data-type="lcd">
  <h4>LCD</h4>
  <label>Label <input type="text" class="ctrl-label"></label>
  <label>Position <select class="ctrl-position"><option>higher</option><option>high</option><option selected></option><option>lower</option></select></label>
  <label>Width <input type="text" class="ctrl-width" value=30></label>
  <label>Height <input type="text" class="ctrl-height" value=10></label>
  <label>Round? <input type="checkbox" class="ctrl-round"></label>
  <label>Screen <input type="checkbox" id="screen1-check"><input type="color" class="ctrl-screen1" value="#111111"></label>
  <label>Color <input type="checkbox" id="screen2-check"><input type="color" class="ctrl-screen2" value="#ff0000"></label>
  <label>Text <input type="text" class="ctrl-text" value="LCD"></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script type="text/template" id="multi-template">
        <div class="control" data-type="multi">
  <h4>Multi Select</h4>
  <label>Label <input type="text" class="ctrl-label"></label>
  <label>Alignment <select class="ctrl-position"><option>left</option><option>right</option><option>lower</option><option selected></option><option>higher</option><option>highest</option><option>align-top</option></select></label>
  <label>Values <input type="text" class="ctrl-values" value="A,B,C"></label>
  <label>Selected <input type="text" class="ctrl-num ctrl-value" value="A"></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script>
        const widths = ["xsmall", "smaller", "small", "medium", "standard", "large", "+large", "larger", "xlarge",
            "xlarger", "largest", "wide", "wider", "widest", "xwidest"];
        const heights = ["xsmall", "smaller", "small", "medium", "standard", "large", "+large", "larger", "xlarge",
            "xlarger", "largest", "tall"];

        // Show numeric input only for margin-left / margin-right
        $("#controls").on("change", ".ctrl-position", function () {
        const val = $(this).val();
        const $input = $(this).siblings(".ctrl-position-value");
        if (val === "margin-left" || val === "margin-right") {
            $input.show();
        } else {
            $input.hide().val("");
        }
        });


        let isSyncing = false;

        // Builder logic
        function buildJSON() {
    if (isSyncing) return; // Skip rebuild during JSON sync

    const pedal = {
        _id: $("#pedal-id").val(),
        name: $("#pedal-name").val(),
        logo: $("#pedal-logo").val(),
        type: $("#pedal-type").val(),
        width: $("#pedal-width").val(),
        height: $("#pedal-height").val(),
        color: $("#pedal-color").val(),
        "font-color": $("#font-color").val(),
        "inside-color": $("#pedal-inside-color").val() + ($("#pedal-inside-full-check").is(":checked") ?
            " full" : ""),
        "knobs-color": "#cccccc",
        "knobs-border": "#000000",
        "knobs-indicator": "#ff0000",
        controls: []
    };

    // small helper for position handling
    function getPosition($control) {
        const posVal = $control.find(".ctrl-position").val();
        const $posInput = $control.find(".ctrl-position-value");
        if (posVal === "margin-left" || posVal === "margin-right") {
            const px = parseInt($posInput.val(), 10) || 0;
            return `${posVal}:${px}px`;
        } else if (posVal && posVal.trim() !== "") {
            return posVal;
        }
        return undefined;
    }

    const logoVal = $("#pedal-logo").val();
    const el = document.createElement("div");
    el.style.cssText = logoVal;
    if (el.getAttribute("style")) {
        console.log("Valid CSS detected");
    } else {
        console.log("Not valid CSS");
    }

    // Add inside-border only if "Full" is checked
    if ($("#pedal-inside-border-check").is(":checked")) {
        pedal["inside-border"] = $("#pedal-inside-border").val();
    } else {
        delete pedal["inside-border"];
    }

    $("#controls .row").each(function () {
        const rowObj = { row: [] };

        $(this).find(".controls-row .control").each(function () {
            const type = $(this).data("type");
            const ctrl = {
                label: $(this).find(".ctrl-label").val(),
                type: type
            };

            if (type.includes("knob")) {
                ctrl.min = parseInt($(this).find(".ctrl-min").val());
                ctrl.max = parseInt($(this).find(".ctrl-max").val());
                ctrl.value = parseInt($(this).find(".ctrl-value").val());
                ctrl["knob-color"] = $(this).find(".ctrl-knob-color").val();
                ctrl["knob-border"] = $(this).find(".ctrl-knob-border").val();
                ctrl["knob-indicator"] = $(this).find(".ctrl-knob-indicator").val();
                const sizeVal = $(this).find(".ctrl-size").val();
                ctrl.type = sizeVal === "regular" ? "knob" : sizeVal;
                const pos = getPosition($(this));
                if (pos) ctrl.position = pos;

            } else if (type === "led") {
                ctrl.colors = [
                    $(this).find(".ctrl-color0").val(),
                    $(this).find(".ctrl-color1").val()
                ];
                ctrl.value = parseInt($(this).find(".ctrl-value").val());
                const pos = getPosition($(this));
                if (pos) ctrl.position = pos;

            } else if (type === "slider") {
                ctrl.orientation = $(this).find(".ctrl-orientation").val();
                ctrl.value = parseInt($(this).find(".ctrl-value").val());
                const pos = getPosition($(this));
                if (pos) ctrl.position = pos;

            } else if (type === "lcd") {
                ctrl.value = $(this).find(".ctrl-text").val();
                ctrl.shape = $(this).find(".ctrl-round").is(":checked") ? "round" : "";
                ctrl.width = parseFloat($(this).find(".ctrl-width").val());
                ctrl.height = parseFloat($(this).find(".ctrl-height").val());
                ctrl["screen-color"] = $(this).find(".ctrl-screen1").val();
                ctrl["text-color"] = $(this).find(".ctrl-screen2").val();
                const pos = getPosition($(this));
                if (pos) ctrl.position = pos;

            } else if (type === "multi") {
                ctrl.values = $(this).find(".ctrl-values").val().split(",");
                ctrl.value = $(this).find(".ctrl-value").val();
                const pos = getPosition($(this));
                if (pos) ctrl.position = pos;
            }

            rowObj.row.push(ctrl);
        });

        pedal.controls.push(rowObj);
    });

    $("#json-output").val(JSON.stringify(pedal, null, 2));
    $("#json-error").text(""); // clear any old error

    const $pedalDiv = $("#pedal-box");
    $pedalDiv.empty().append(renderPedal(pedal));
}


        $(function () {
            widths.forEach(w => $("#pedal-width").append(`<option>${w}</option>`));
            heights.forEach(h => $("#pedal-height").append(`<option>${h}</option>`));
            $("#pedal-width").val("standard");
            $("#pedal-height").val("standard");

            // Add control row
            $("#add-row").on("click", function () {
                const row = $(`
                    <div class="row" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                        <div class="row-buttons" style="display:flex; gap:10px;">
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-knob">+ Knob</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-led">+ LED</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-slider">+ Slider</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-lcd">+ LCD</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-multi">+ Multi</button>
                        </div>
                        <div class="controls-row" style="display:flex; gap:10px; flex-wrap:nowrap;"></div>
                        <div class="row-actions">
                        <button class="bx--btn bx--btn--sm bx--btn--secondary row-up">↑ Row</button><br>
                        <button class="bx--btn bx--btn--sm bx--btn--secondary row-down">↓ Row</button><br>
                        <button class="bx--btn bx--btn--sm bx--btn--danger row-remove">✕ Remove Row</button>
                        </div>
                    </div>
                    `);
                $("#controls").append(row);
                buildJSON();
            });

            function addControl(buttonClass, templateId) {
                $("#controls").on("click", buttonClass, function () {
                    const controlsRow = $(this).closest(".row").find(".controls-row");
                    controlsRow.append($(templateId).html());
                    buildJSON();
                });
            }
            addControl(".add-knob", "#knob-template");
            addControl(".add-led", "#led-template");
            addControl(".add-slider", "#slider-template");
            addControl(".add-lcd", "#lcd-template");
            addControl(".add-multi", "#multi-template");

            // Move/remove controls
            $("#controls").on("click", ".remove", function () {
                $(this).closest(".control").remove();
                buildJSON();
            });
            $("#controls").on("click", ".move-up", function () {
                const c = $(this).closest(".control");
                c.prev(".control").before(c);
                buildJSON();
            });
            $("#controls").on("click", ".move-down", function () {
                const c = $(this).closest(".control");
                c.next(".control").after(c);
                buildJSON();
            });

            // Row actions
            $("#controls").on("click", ".row-remove", function () {
                $(this).closest(".row").remove();
                buildJSON();
            });
            $("#controls").on("click", ".row-up", function () {
                const r = $(this).closest(".row");
                r.prev(".row").before(r);
                buildJSON();
            });
            $("#controls").on("click", ".row-down", function () {
                const r = $(this).closest(".row");
                r.next(".row").after(r);
                buildJSON();
            });

            $("#editor, #controls").on("input change keyup", "input, select, textarea", buildJSON);
            buildJSON();
        });



        $("#json-output").on("input", function () {
            const $err = $("#json-error");
            try {
                const parsed = JSON.parse($(this).val());
                $err.text(""); // clear error if valid
                syncUIFromJSON(parsed);
            } catch (e) {
                $err.text("Invalid JSON: " + e.message);
            }
        });
    </script>




    <script>
        function syncUIFromJSON(pedal) {

            isSyncing = true; // Disable buildJSON()

            // Basic info
            $("#pedal-id").val(pedal._id || "");
            $("#pedal-name").val(pedal.name || "");
            $("#pedal-logo").val(pedal.logo || "");
            $("#pedal-type").val(pedal.type || "pedal");
            $("#pedal-width").val(pedal.width || "standard");
            $("#pedal-height").val(pedal.height || "standard");
            $("#pedal-color").val(pedal.color || "#264985");
            $("#font-color").val(pedal["font-color"] || "#ffffff");

            // Inside color + full/border
            if (pedal["inside-color"]) {
                const full = pedal["inside-color"].includes("full");
                $("#pedal-inside-full-check").prop("checked", full);
                $("#pedal-inside-color").val(pedal["inside-color"].replace(" full", ""));
                $("#inside-border-label").toggle(full);
            }
            if (pedal["inside-border"]) {
                $("#pedal-inside-border-check").prop("checked", true);
                $("#pedal-inside-border").val(pedal["inside-border"]);
            } else {
                $("#pedal-inside-border-check").prop("checked", false);
            }

            // Clear & rebuild controls
            $("#controls").empty();
            if (Array.isArray(pedal.controls)) {
                pedal.controls.forEach(rowObj => {
                    $("#add-row").trigger("click"); // add empty row
                    const $lastRow = $("#controls .row").last();
                    const $controlsRow = $lastRow.find(".controls-row");

                    rowObj.row.forEach(ctrl => {
                        // Pick template
                        let templateId;
                        switch (ctrl.type) {
                            case "knob":
                            case "smallknob":
                            case "largeknob":
                            case "xlargeknob":
                                templateId = "#knob-template";
                                break;
                            case "led":
                                templateId = "#led-template";
                                break;
                            case "slider":
                                templateId = "#slider-template";
                                break;
                            case "lcd":
                                templateId = "#lcd-template";
                                break;
                            case "multi":
                                templateId = "#multi-template";
                                break;
                        }
                        if (templateId) {
                            const $ctrl = $($(templateId).html());
                            $ctrl.find(".ctrl-label").val(ctrl.label || "");

                            if (ctrl.type.includes("knob")) {
                                $ctrl.find(".ctrl-size").val(ctrl.type);
                                $ctrl.find(".ctrl-min").val(ctrl.min);
                                $ctrl.find(".ctrl-max").val(ctrl.max);
                                $ctrl.find(".ctrl-value").val(ctrl.value);
                                $ctrl.find(".ctrl-knob-color").val(ctrl["knob-color"]);
                                $ctrl.find(".ctrl-knob-border").val(ctrl["knob-border"]);
                                $ctrl.find(".ctrl-knob-indicator").val(ctrl["knob-indicator"]);
                                $ctrl.find(".ctrl-position").val(ctrl.position || "");
                            } else if (ctrl.type === "led") {
                                $ctrl.find(".ctrl-color0").val(ctrl.colors?.[0] || "#000000");
                                $ctrl.find(".ctrl-color1").val(ctrl.colors?.[1] || "#ff0000");
                                $ctrl.find(".ctrl-value").val(ctrl.value);
                                $ctrl.find(".ctrl-position").val(ctrl.position || "");
                            } else if (ctrl.type === "slider") {
                                $ctrl.find(".ctrl-orientation").val(ctrl.orientation || "vertical");
                                $ctrl.find(".ctrl-min").val(ctrl.min);
                                $ctrl.find(".ctrl-max").val(ctrl.max);
                                $ctrl.find(".ctrl-value").val(ctrl.value);
                                $ctrl.find(".ctrl-position").val(ctrl.position || "");
                            } else if (ctrl.type === "lcd") {
                                $ctrl.find(".ctrl-text").val(ctrl.value || "LCD");
                                $ctrl.find(".ctrl-round").prop("checked", ctrl.shape === "round");
                                $ctrl.find(".ctrl-position").val(ctrl.position || "");
                            } else if (ctrl.type === "multi") {
                                $ctrl.find(".ctrl-values").val(ctrl.values?.join(",") || "");
                                $ctrl.find(".ctrl-value").val(ctrl.value);
                                $ctrl.find(".ctrl-position").val(ctrl.position || "");
                            }

                            $controlsRow.append($ctrl);
                        }
                    });
                });
            }

            isSyncing = false; // Re-enable buildJSON
            buildJSON(); // Rebuild once

            // Re-render pedal
            $("#pedal-box").empty().append(renderPedal(pedal));

        }
    </script>

</body>

</html>