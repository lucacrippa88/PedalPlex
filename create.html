<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Pedal Builder</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/carbon-components/css/carbon-components.min.css" />
    <link rel="stylesheet" href="style.css">
    <script src="utils.js"></script>
    <style>

        /* Make the builder container a flex layout */
#builder {
  display: flex;
  align-items: flex-start;
}

/* Editor takes the left side and can scroll */
#editor {
  flex: 1;
  padding: 20px;
  max-width: 60%; /* optional, keep it readable */
}

/* Preview stays fixed on the right */
#preview {
  position: fixed;
  right: 20px;
  top: 20px;
  bottom: 20px;
  width: 55%;
  /* max-width: 500px; */
  overflow: auto;       /* ✅ scrolls if pedal is too big */
  /* background: #fff; */
  /* border: 1px solid #ddd; */
  padding: 15px;
  border-radius: 8px;
  /* box-shadow: 0 2px 8px rgba(0,0,0,0.1); */
}

body {
  margin: 0;
  padding-right: 40%; /* reserve space for preview */
}


    </style>
</head>

<body>

    <div id="builder">

        <div id="editor">
            <h2>Gear Quick Creation</h2><br><br>
            <div class="pedal-info">
                <label>ID <input type="text" class="create-gear-input" id="pedal-id" placeholder="Insert unique gear ID..."></label>
                <label>Name <input type="text" class="create-gear-input" id="pedal-name" placeholder="Insert gear name..."></label>
                <label>Logo style <input type="text" class="create-gear-input" id="pedal-logo" placeholder="Set valid CSS..."></label>
            </div>
            <br>
            <label>Type <select id="pedal-type">
                    <option value="pedal">Pedal</option>
                    <option value="pedal-inverted">Pedal Inverted</option>
                    <option value="expression">Expression</option>
                    <option value="combo">Combo</option>
                    <option value="head">Head</option>
                    <option value="round">Round</option>
                </select>
                <label>Width <select id="pedal-width"></select></label>
                <label>Height <select id="pedal-height"></select></label>
                <br><br>
                <label>Color <input type="color" id="pedal-color" value="#264985"></label>&ensp;&ensp;
                <label>Font Color <input type="color" id="font-color" value="#ffffff"></label>&ensp;&ensp;
                <label> Inside Color (Full <input type="checkbox" id="pedal-inside-full-check">)</label><input type="color" id="pedal-inside-color" value="#0d0d0d">&ensp;&ensp;
                <label id="inside-border-label" style="display:none;"> Inside Border <input type="checkbox" id="pedal-inside-border-check"><input type="color" id="pedal-inside-border" value="#ffffff"></label>
                <br><br>
                <label>Knobs Color <input type="color" id="knobs-color" value="#191919"></label>&ensp;&ensp;
                <label>Knobs Border <input type="color" id="knobs-border" value="#424242"></label>&ensp;&ensp;
                <label>Knobs Indicator <input type="color" id="knobs-indicator" value="#ffffff"></label>&ensp;&ensp;
                <script>
                    $("#pedal-inside-full-check").on("change", function () {
                        $("#inside-border-label").toggle(this.checked);
                    });
                </script>

                <hr>
                <button class="bx--btn bx--btn--sm bx--btn--primary" id="add-row">+ Add Control Row</button>
                <div id="controls"></div>
        </div>



        <div id="preview">

        <button id="toggle-preview">Hide Preview</button>
        <div id="pedal-box"></div>
        </div>
    </div>

    <script>$("#toggle-preview").on("click", function() {
                $("#pedal-box").toggle();
                $(this).text($("#pedal-box").is(":visible") ? "Hide Preview" : "Show Preview");
            });
    </script>

            <h2>Generated JSON</h2><br><br>
            <textarea id="json-output" style="width:100%;height:300px;font-family:monospace;"></textarea>
            <div id="json-error" style="color:red; font-weight:bold; margin-top:5px;"></div>




    <!-- Templates -->
    <script type="text/template" id="knob-template">
        <div class="control" data-type="knob">
        <h4>Knob</h4>
        <label>Label <input type="text" class="ctrl-label"></label>
        <label>Knob Type</label>
            <select class="ctrl-knob-type">
                <option value="numeric">Numeric</option>
                <option value="discrete">Discrete</option>
            </select>
        <label>Size <select class="ctrl-size">
            <option value="knob" selected>Regular</option>
            <option value="smallknob">Small</option>
            <option value="largeknob">Large</option>
            <option value="xlargeknob">XLarge</option>
            </select>
        </label>
        <label>Position 
            <select class="ctrl-position">
            <option></option>
            <option>highest</option>
            <option>higher</option>
            <option>high</option>
            <option>low</option>
            <option>lower</option>
            <option>lowest</option>
            <option>under-top</option>
            <option>align-top</option>
            <option>align-top-clear</option>
            <option>align-top-clearer</option>
            <option value="margin-left">Margin Left</option>
            <option value="margin-right">Margin Right</option>
            </select>
        </label>
        <input type="number" class="ctrl-position-value" placeholder="px" min="0" style="display:none; width:50px;">
        <label>
            <input type="checkbox" class="ctrl-knob-color-enable"> Knob
            <input type="color" class="ctrl-knob-color" disabled>
        </label>
        <label>
            <input type="checkbox" class="ctrl-knob-border-enable"> Border
            <input type="color" class="ctrl-knob-border" disabled>
        </label>
        <label>
            <input type="checkbox" class="ctrl-knob-indicator-enable"> Indicator
            <input type="color" class="ctrl-knob-indicator" disabled>
        </label>
        <label>
            <input type="checkbox" class="ctrl-knob-thick"> Thick Border
        </label>
        <span class="numeric-fields">
            <label>Min <input type="number" class="ctrl-num ctrl-min" value="7"></label>
            <label>Max <input type="number" class="ctrl-num ctrl-max" value="17"></label>
            <label>Val <input type="number" class="ctrl-num ctrl-value" value="12"></label>
        </span>
        <span class="discrete-fields" style="display:none;">
            <label>Values <input type="text" class="ctrl-values-list" placeholder="A,B,C"></label>
            <label>Current Value <select class="ctrl-value-select"></select></label>
        </span>
        <label>Span
            <select class="ctrl-span">
                <option value="all">12->12</option>
                <option value="three-quarters" selected>7->17</option>
                <option value="half">6->12</option>
                <option value="half-shift">14<-20</option>
                <option value="half-shift-inverted">17->23</option>
                <option value="quarter">13->10</option>
                <option value="tenToTwo">10->14</option>
            </select>
        </label>



        <br>
        <div class="ctrl-actions">
            <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
            <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
            <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
        </div>
        </div>
        </script>

    <script type="text/template" id="led-template">
        <div class="control" data-type="led">
  <h4>LED</h4>
  <label>Label <input type="text" class="ctrl-label"></label><input type="checkbox" class="ctrl-showlabel">
        <label>Position 
            <select class="ctrl-position">
            <option></option>
            <option>highest</option>
            <option>higher</option>
            <option>high</option>
            <option>low</option>
            <option>lower</option>
            <option>lowest</option>
            <option>xlow</option>
            <option>right</option>
            <option>under-top</option>
            <option>align-top</option>
            <option value="margin-left">Margin Left</option>
            <option value="margin-right">Margin Right</option>
            </select>
        </label>
        <input type="number" class="ctrl-position-value" placeholder="px" min="0" style="display:none; width:50px;">  <label>Color OFF <input type="color" class="ctrl-color0" value="#000000"></label>
  <label>Color ON <input type="color" class="ctrl-color1" value="#f70000"></label>
  <label>Value <select class="ctrl-value"><option value="0">Off</option><option value="1">On</option></select></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script type="text/template" id="slider-template">
        <div class="control" data-type="slider">
  <h4>Slider</h4>
  <label>Label <input type="text" class="ctrl-label"></label>
  <label>Orientation <select class="ctrl-orientation"><option selected>vertical</option><option>vertical small</option><option>horizontal</option></select></label>
  <label>Min <input type="number" class="ctrl-num ctrl-min" value="-15"></label>
  <label>Max <input type="number" class="ctrl-num ctrl-max" value="15"></label>
  <label>Value <input type="number" class="ctrl-num ctrl-value" value="0"></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script type="text/template" id="lcd-template">
        <div class="control" data-type="lcd">
  <h4>LCD</h4>
  <label>Label <input type="text" class="ctrl-label"></label>
<label>Position 
            <select class="ctrl-position">
            <option></option>
            <option>higher</option>
            <option>high</option>
            <option>lower</option>
            </select>
        </label>
    <label>Width <input type="text" class="ctrl-width" value=30></label>
  <label>Height <input type="text" class="ctrl-height" value=10></label>
  <label>Round? <input type="checkbox" class="ctrl-round"></label>
  <label>Screen <input type="checkbox" id="screen1-check"><input type="color" class="ctrl-screen1" value="#111111"></label>
  <label>Color <input type="checkbox" id="screen2-check"><input type="color" class="ctrl-screen2" value="#ff0000"></label>
  <label>Text <input type="text" class="ctrl-text" value="LCD"></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script type="text/template" id="multi-template">
        <div class="control" data-type="multi">
  <h4>Multi Select</h4>
  <label>Label <input type="text" class="ctrl-label"></label><input type="checkbox" class="ctrl-showlabel">
  <label>Position 
            <select class="ctrl-position">
            <option></option>
            <option>highest</option>
            <option>higher</option>
            <option>lower</option>
            <option>right</option>
            <option>left</option>
            <option>align-top</option>
            <option value="margin-left">Margin Left</option>
            <option value="margin-right">Margin Right</option>
            </select>
        </label>
        <input type="number" class="ctrl-position-value" placeholder="px" min="0" style="display:none; width:50px;">  <label>Color OFF <input type="color" class="ctrl-color0" value="#000000"></label>
    <label>Values <input type="text" class="ctrl-values" value="A,B,C"></label>
  <label>Selected <input type="text" class="ctrl-num ctrl-value" value="A"></label>
  <br>
  <div class="ctrl-actions">
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-up">↑</button>
    <button class="bx--btn bx--btn--sm bx--btn--secondary move-down">↓</button>
    <button class="bx--btn bx--btn--sm bx--btn--danger remove">✕</button>
  </div>
</div>
</script>

    <script>
        const widths = ["xsmall", "smaller", "small", "medium", "standard", "large", "+large", "larger", "xlarge",
            "xlarger", "largest", "wide", "wider", "widest", "xwidest"];
        const heights = ["xsmall", "smaller", "small", "medium", "standard", "large", "+large", "larger", "xlarge",
            "xlarger", "largest", "tall"];

        // Show numeric input only for margin-left / margin-right
        $("#controls").on("change", ".ctrl-position", function () {
            const val = $(this).val();
            const $numInput = $(this).closest("label").next(".ctrl-position-value");
            if (val === "margin-left" || val === "margin-right") {
                $numInput.show();
            } else {
                $numInput.hide().val("");
            }
            buildJSON();
        });


        // Enable/disable knob color inputs
        $("#controls").on("change", ".ctrl-knob-color-enable", function () {
            $(this).siblings(".ctrl-knob-color").prop("disabled", !this.checked);
            buildJSON();
        });
        $("#controls").on("change", ".ctrl-knob-border-enable", function () {
            $(this).siblings(".ctrl-knob-border").prop("disabled", !this.checked);
            buildJSON();
        });
        $("#controls").on("change", ".ctrl-knob-indicator-enable", function () {
            $(this).siblings(".ctrl-knob-indicator").prop("disabled", !this.checked);
            buildJSON();
        });

        // Select knob type
        $(document).on("change", ".ctrl-knob-type", function () {
            const $ctrl = $(this).closest(".control");

            if ($(this).val() === "numeric") {
                $ctrl.find(".numeric-fields").show();
                $ctrl.find(".discrete-fields").hide();
            } else {
                $ctrl.find(".numeric-fields").hide();
                $ctrl.find(".discrete-fields").show();
            }
        });




        let isSyncing = false;

 // Builder logic
function buildJSON() {

    if (isSyncing) return; // Skip rebuild during JSON sync

    const pedal = {
        _id: $("#pedal-id").val(),
        name: $("#pedal-name").val(),
        logo: $("#pedal-logo").val(),
        type: $("#pedal-type").val(),
        width: $("#pedal-width").val(),
        height: $("#pedal-height").val(),
        color: $("#pedal-color").val(),
        "font-color": $("#font-color").val(),
        "inside-color": $("#pedal-inside-color").val() + ($("#pedal-inside-full-check").is(":checked") ? " full" : ""),
        "knobs-color": $("#knobs-color").val(),
        "knobs-border": $("#knobs-border").val(),
        "knobs-indicator": $("#knobs-indicator").val(),
        controls: []
    };

    const logoVal = $("#pedal-logo").val();
    const el = document.createElement("div");
    el.style.cssText = logoVal;

    if (el.getAttribute("style")) {
        console.log("Valid CSS detected");
    } else {
        console.log("Not valid CSS");
    }

    // Add inside-border only if "Full" is checked
    if ($("#pedal-inside-border-check").is(":checked")) {
        pedal["inside-border"] = $("#pedal-inside-border").val();
    } else {
        delete pedal["inside-border"]; // Ensure it's not left behind
    }

    // --- helper for position ---
    function getPosition($control) {
        const posVal = $control.find(".ctrl-position").val();
        const $posInput = $control.find(".ctrl-position-value");

        if (posVal === "margin-left" || posVal === "margin-right") {
            const px = parseInt($posInput.val(), 10) || 0;
            return `${posVal}:${px}px`;
        } else if (posVal && posVal.trim() !== "") {
            return posVal;
        }
        return undefined;
    }

    // --- loop over rows/controls ---
    $("#controls .row").each(function () {
        const rowObj = { row: [] };
        $(this).find(".controls-row .control").each(function () {
            const type = $(this).data("type");
            const ctrl = {
                label: $(this).find(".ctrl-label").val(),
                type: type
            };

if (type.includes("knob")) {

    const knobType = $(this).find(".ctrl-knob-type").val();

    if (knobType === "discrete") {
        const valuesText = $(this).find(".ctrl-values-list").val().trim();
        const valuesArray = valuesText.split(",").map(v => v.trim());
        ctrl.values = valuesArray;
        ctrl.value = $(this).find(".ctrl-value-select").val() || valuesArray[0];
    } else {
        ctrl.min = parseInt($(this).find(".ctrl-min").val());
        ctrl.max = parseInt($(this).find(".ctrl-max").val());
        ctrl.value = parseInt($(this).find(".ctrl-value").val());
    }

    // ✅ Always handle span once (numeric or discrete)
    const spanVal = $(this).find(".ctrl-span").val();
    if (spanVal) ctrl.span = spanVal;

    if ($(this).find(".ctrl-knob-color-enable").is(":checked")) {
        ctrl["knob-color"] = $(this).find(".ctrl-knob-color").val();
    }
    if ($(this).find(".ctrl-knob-border-enable").is(":checked")) {
        ctrl["knob-border"] = $(this).find(".ctrl-knob-border").val();
    }
    if ($(this).find(".ctrl-knob-indicator-enable").is(":checked")) {
        ctrl["knob-indicator"] = $(this).find(".ctrl-knob-indicator").val();
    }
    if ($(this).find(".ctrl-knob-thick").is(":checked")) {
        ctrl.border = "thick";
    }

    const sizeVal = $(this).find(".ctrl-size").val();
    ctrl.type = sizeVal === "regular" ? "knob" : sizeVal;

    const pos = getPosition($(this));
    if (pos) ctrl.position = pos;
}
            else if (type === "led") {
                ctrl.colors = [
                    $(this).find(".ctrl-color0").val(),
                    $(this).find(".ctrl-color1").val()
                ];
                ctrl.value = parseInt($(this).find(".ctrl-value").val());
                ctrl.showlabel = $(this).find(".ctrl-showlabel").is(":checked") ? "yes" : "no";
                const pos = getPosition($(this));
                if (pos) ctrl.position = pos;

            } else if (type === "slider") {
                ctrl.orientation = $(this).find(".ctrl-orientation").val();
                ctrl.value = parseInt($(this).find(".ctrl-value").val());
                const pos = getPosition($(this));
                if (pos) ctrl.position = pos;

            } else if (type === "lcd") {
                ctrl.value = $(this).find(".ctrl-text").val();
                ctrl.shape = $(this).find(".ctrl-round").is(":checked") ? "round" : "";
                ctrl.width = parseFloat($(this).find(".ctrl-width").val());
                ctrl.height = parseFloat($(this).find(".ctrl-height").val());
                ctrl["screen-color"] = $(this).find(".ctrl-screen1").val();
                ctrl["text-color"] = $(this).find(".ctrl-screen2").val();
                const pos = getPosition($(this));
                if (pos) ctrl.position = pos;

            } else if (type === "multi") {
                ctrl.values = $(this).find(".ctrl-values").val().split(",");
                ctrl.value = $(this).find(".ctrl-value").val();
                ctrl.showlabel = $(this).find(".ctrl-showlabel").is(":checked") ? "yes" : "no";
                const pos = getPosition($(this));
                if (pos) ctrl.position = pos;
            }

            rowObj.row.push(ctrl);
        });
        pedal.controls.push(rowObj);
    });

    $("#json-output").val(JSON.stringify(pedal, null, 2));
    $("#json-error").text(""); // clear any old error

    const $pedalDiv = $("#pedal-box");
    $pedalDiv.empty().append(renderPedal(pedal));
}



        $(function () {
            widths.forEach(w => $("#pedal-width").append(`<option>${w}</option>`));
            heights.forEach(h => $("#pedal-height").append(`<option>${h}</option>`));
            $("#pedal-width").val("standard");
            $("#pedal-height").val("standard");

            // Add control row
            $("#add-row").on("click", function () {
                const row = $(`
                    <div class="row" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                        <div class="row-buttons" style="display:flex; gap:10px;">
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-knob">+ Knob</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-led">+ LED</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-slider">+ Slider</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-lcd">+ LCD</button>
                        <button class="bx--btn bx--btn--sm bx--btn--tertiary add-control add-multi">+ Multi</button>
                        </div>
                        <div class="controls-row" style="display:flex; gap:10px; flex-wrap:nowrap;"></div>
                        <div class="row-actions">
                        <button class="bx--btn bx--btn--sm bx--btn--secondary row-up">↑ Row</button><br>
                        <button class="bx--btn bx--btn--sm bx--btn--secondary row-down">↓ Row</button><br>
                        <button class="bx--btn bx--btn--sm bx--btn--danger row-remove">✕ Remove Row</button>
                        </div>
                    </div>
                    `);
                $("#controls").append(row);
                buildJSON();
            });

            function addControl(buttonClass, templateId) {
                $("#controls").on("click", buttonClass, function () {
                    const controlsRow = $(this).closest(".row").find(".controls-row");
                    controlsRow.append($(templateId).html());
                    buildJSON();
                });
            }
            addControl(".add-knob", "#knob-template");
            addControl(".add-led", "#led-template");
            addControl(".add-slider", "#slider-template");
            addControl(".add-lcd", "#lcd-template");
            addControl(".add-multi", "#multi-template");

            // Move/remove controls
            $("#controls").on("click", ".remove", function () {
                $(this).closest(".control").remove();
                buildJSON();
            });
            $("#controls").on("click", ".move-up", function () {
                const c = $(this).closest(".control");
                c.prev(".control").before(c);
                buildJSON();
            });
            $("#controls").on("click", ".move-down", function () {
                const c = $(this).closest(".control");
                c.next(".control").after(c);
                buildJSON();
            });

            // Row actions
            $("#controls").on("click", ".row-remove", function () {
                $(this).closest(".row").remove();
                buildJSON();
            });
            $("#controls").on("click", ".row-up", function () {
                const r = $(this).closest(".row");
                r.prev(".row").before(r);
                buildJSON();
            });
            $("#controls").on("click", ".row-down", function () {
                const r = $(this).closest(".row");
                r.next(".row").after(r);
                buildJSON();
            });

            $("#editor, #controls").on("input change keyup", "input, select, textarea", buildJSON);
            buildJSON();
        });

// Sync values list to select options for knobs
            $("#controls").on("input", ".ctrl-values-list", function() {
        const $row = $(this).closest(".control");
        const values = $(this).val().split(",").map(v => v.trim()).filter(v => v);
        const $select = $row.find(".ctrl-value-select");
        $select.empty();
        values.forEach(v => $select.append(`<option>${v}</option>`));
        buildJSON();
    });



        $("#json-output").on("input", function () {
            const $err = $("#json-error");
            try {
                const parsed = JSON.parse($(this).val());
                $err.text(""); // clear error if valid
                syncUIFromJSON(parsed);
            } catch (e) {
                $err.text("Invalid JSON: " + e.message);
            }
        });
    </script>




    <script>
function syncUIFromJSON(pedal) {

    isSyncing = true; // Disable buildJSON()

    // --- Helper: restore position (dropdown + numeric px) ---
    function applyPosition($ctrl, ctrl) {
        if (ctrl.position) {
            if (ctrl.position.startsWith("margin-left:") || ctrl.position.startsWith("margin-right:")) {
                const [side, pxVal] = ctrl.position.split(":");
                $ctrl.find(".ctrl-position").val(side);
                $ctrl.find(".ctrl-position-value")
                    .val(parseInt(pxVal)) // strip "px"
                    .show();
            } else {
                $ctrl.find(".ctrl-position").val(ctrl.position);
                $ctrl.find(".ctrl-position-value").val("").hide();
            }
        } else {
            $ctrl.find(".ctrl-position").val("").hide();
        }
    }

    // --- Basic pedal info ---
    $("#pedal-id").val(pedal._id || "");
    $("#pedal-name").val(pedal.name || "");
    $("#pedal-logo").val(pedal.logo || "");
    $("#pedal-type").val(pedal.type || "pedal");
    $("#pedal-width").val(pedal.width || "standard");
    $("#pedal-height").val(pedal.height || "standard");
    $("#pedal-color").val(pedal.color || "#264985");
    $("#font-color").val(pedal["font-color"] || "#ffffff");
    $("#knobs-color").val(pedal["knobs-color"] || "#191919");
    $("#knobs-border").val(pedal["knobs-border"] || "#424242");
    $("#knobs-indicator").val(pedal["knobs-indicator"] || "#ffffff");

    // --- Inside color + full/border ---
    if (pedal["inside-color"]) {
        const full = pedal["inside-color"].includes("full");
        $("#pedal-inside-full-check").prop("checked", full);
        $("#pedal-inside-color").val(pedal["inside-color"].replace(" full", ""));
        $("#inside-border-label").toggle(full);
    }
    if (pedal["inside-border"]) {
        $("#pedal-inside-border-check").prop("checked", true);
        $("#pedal-inside-border").val(pedal["inside-border"]);
    } else {
        $("#pedal-inside-border-check").prop("checked", false);
    }

    // --- Clear & rebuild controls ---
    $("#controls").empty();
    if (Array.isArray(pedal.controls)) {
        pedal.controls.forEach(rowObj => {
            $("#add-row").trigger("click"); // add empty row
            const $lastRow = $("#controls .row").last();
            const $controlsRow = $lastRow.find(".controls-row");

            rowObj.row.forEach(ctrl => {
                // --- Pick template ---
                let templateId;
                switch (ctrl.type) {
                    case "knob":
                    case "smallknob":
                    case "largeknob":
                    case "xlargeknob":
                        templateId = "#knob-template";
                        break;
                    case "led":
                        templateId = "#led-template";
                        break;
                    case "slider":
                        templateId = "#slider-template";
                        break;
                    case "lcd":
                        templateId = "#lcd-template";
                        break;
                    case "multi":
                        templateId = "#multi-template";
                        break;
                }
                if (!templateId) return;

                const $ctrl = $($(templateId).html());
                $ctrl.find(".ctrl-label").val(ctrl.label || "");

                // --- KNOB ---
                if (ctrl.type.includes("knob")) {
                    $ctrl.find(".ctrl-size").val(ctrl.type);

                    if (Array.isArray(ctrl.values) && ctrl.values.length > 0) {
                        // DISCRETE
                        $ctrl.find(".ctrl-knob-type").val("discrete").trigger("change");
                        $ctrl.find(".ctrl-values-list").val(ctrl.values.join(","));
                        const $select = $ctrl.find(".ctrl-value-select");
                        $select.empty();
                        ctrl.values.forEach(v => $select.append(`<option>${v}</option>`));
                        $select.val(ctrl.value || ctrl.values[0]);
                        $ctrl.find(".ctrl-span").val(ctrl.span || "");
                    } else {
                        // NUMERIC
                        $ctrl.find(".ctrl-knob-type").val("numeric").trigger("change");
                        $ctrl.find(".ctrl-min").val(ctrl.min ?? "");
                        $ctrl.find(".ctrl-max").val(ctrl.max ?? "");
                        $ctrl.find(".ctrl-value").val(ctrl.value ?? "");
                        $ctrl.find(".ctrl-values-list").val("");
                        $ctrl.find(".ctrl-value-select").empty();
                        $ctrl.find(".ctrl-span").val(ctrl.span || "");
                    }

                    if (ctrl["knob-color"]) {
                        $ctrl.find(".ctrl-knob-color-enable").prop("checked", true);
                        $ctrl.find(".ctrl-knob-color").prop("disabled", false).val(ctrl["knob-color"]);
                    }
                    if (ctrl["knob-border"]) {
                        $ctrl.find(".ctrl-knob-border-enable").prop("checked", true);
                        $ctrl.find(".ctrl-knob-border").prop("disabled", false).val(ctrl["knob-border"]);
                    }
                    if (ctrl["knob-indicator"]) {
                        $ctrl.find(".ctrl-knob-indicator-enable").prop("checked", true);
                        $ctrl.find(".ctrl-knob-indicator").prop("disabled", false).val(ctrl["knob-indicator"]);
                    }
                    if (ctrl.border === "thick") {
                        $ctrl.find(".ctrl-knob-thick").prop("checked", true);
                    }

                    applyPosition($ctrl, ctrl);

                // --- LED ---
                } else if (ctrl.type === "led") {
                    $ctrl.find(".ctrl-color0").val(ctrl.colors?.[0] || "#000000");
                    $ctrl.find(".ctrl-color1").val(ctrl.colors?.[1] || "#ff0000");
                    $ctrl.find(".ctrl-value").val(ctrl.value);
                    $ctrl.find(".ctrl-showlabel").prop("checked", ctrl.showlabel === "yes");

                    applyPosition($ctrl, ctrl);

                // --- SLIDER ---
                } else if (ctrl.type === "slider") {
                    $ctrl.find(".ctrl-orientation").val(ctrl.orientation || "vertical");
                    $ctrl.find(".ctrl-min").val(ctrl.min);
                    $ctrl.find(".ctrl-max").val(ctrl.max);
                    $ctrl.find(".ctrl-value").val(ctrl.value);

                    applyPosition($ctrl, ctrl);

                // --- LCD ---
                } else if (ctrl.type === "lcd") {
                    $ctrl.find(".ctrl-text").val(ctrl.value || "LCD");
                    $ctrl.find(".ctrl-round").prop("checked", ctrl.shape === "round");
                    $ctrl.find(".ctrl-width").val(ctrl.width || "");
                    $ctrl.find(".ctrl-height").val(ctrl.height || "");
                    $ctrl.find(".ctrl-screen1").val(ctrl["screen-color"] || "#111111");
                    $ctrl.find(".ctrl-screen2").val(ctrl["text-color"] || "#ff0000");

                    applyPosition($ctrl, ctrl);

                // --- MULTI ---
                } else if (ctrl.type === "multi") {
                    $ctrl.find(".ctrl-values").val(ctrl.values?.join(",") || "");
                    $ctrl.find(".ctrl-value").val(ctrl.value);
                    $ctrl.find(".ctrl-showlabel").prop("checked", ctrl.showlabel === "yes");

                    applyPosition($ctrl, ctrl);
                }

                $controlsRow.append($ctrl);
            });
        });
    }

    isSyncing = false; // Re-enable buildJSON
    buildJSON(); // Rebuild once

    // Re-render pedal
    $("#pedal-box").empty().append(renderPedal(pedal));
}


    </script>

</body>

</html>