<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Test Single Pedal</title>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="utils.js"></script>
<style>
  body { font-family:sans-serif; padding:20px; }
  #results { margin-top: 20px; border: 1px solid #ccc; padding: 10px; min-height: 200px; }
  .pedal-wrapper { display:inline-block; margin:5px; }
  .pedal-catalog { display:flex; justify-content:center; align-items:center; font-size:12px; text-align:center; }
  .pedal-name, .head-name { font-weight:bold; }
  .preset-container { margin-top:5px; position:relative; }
  .preset-dropdown-wrapper { display:none; position:absolute; top:30px; left:0; background:#fff; border:1px solid #ccc; z-index:1000; width:200px; }
  .preset-dropdown-wrapper.is-open { display:block; }
  .preset-dropdown { list-style:none; padding:5px; margin:0; }
  .preset-dropdown li { padding:3px 5px; cursor:pointer; }
  .applied-preset-info { margin-top:5px; display:none; background:#f2f2f2; padding:3px 5px; border-radius:3px; font-size:0.8em; }
  .bx--tag { margin:2px; padding:2px 5px; border-radius:3px; font-size:0.75em; display:inline-block; }
</style>
</head>
<body>

<h1>TEST PEDALBOARD SINGLE PEDAL MODE</h1>
<div id="results">Caricamento pedalboard...</div>

<script>
(async function() {

  const resultsDiv = document.getElementById('results');
  window.resultsDiv = resultsDiv;

  // === MOCK CATALOG (esempio minimo) ===
  if (!window.catalog) {
    window.catalog = [
      {
        _id: 'pedal1',
        name: 'Distortion X',
        type: 'pedal',
        width: 100,
        height: 60,
        color: '#ff0000',
        "font-color": '#ffffff',
        "inside-color": '#ff6666',
        "inside-border": '#000000',
        logo: '',
        controls: [
          { row: [{ label:'Gain', value:5, type:'knob' }] },
          { row: [{ label:'Level', value:7, type:'knob' }] }
        ],
        subplex: [],
      },
      {
        _id: 'pedal2',
        name: 'Chorus Z',
        type: 'pedal',
        width: 90,
        height: 50,
        color: '#0000ff',
        "font-color": '#ffffff',
        "inside-color": '#6666ff',
        "inside-border": '#000000',
        logo: '',
        controls: [
          { row: [{ label:'Depth', value:3, type:'knob' }] },
          { row: [{ label:'Rate', value:4, type:'knob' }] }
        ],
        subplex: [],
      }
    ];
  }

  // === SINGLE PEDAL MODE ===
  window.__SINGLE_PEDAL_MODE__ = true;

  // Recupera pedale da query string ?id=pedal1
  const pedalId = new URLSearchParams(window.location.search).get('id') || 'pedal1';

  function getPedalFromCatalogById(id) {
    return window.catalog.find(p =>
      p._id === id || p.name === id || p._id?.normalize() === id.normalize() || p.name?.normalize() === id.normalize()
    ) || null;
  }

  const pedal = getPedalFromCatalogById(pedalId);

  if (!pedal) {
    Swal.fire({ icon: 'error', title: 'Pedale non trovato', text: pedalId });
    resultsDiv.innerHTML = 'Pedale non trovato: ' + pedalId;
    return;
  }

  // Inizializza catalogMap (necessario per utils.js)
  window.catalogMap = {};
  window.catalogMap[pedal._id] = pedal;

  // Fake pedalboard
  const fakeBoard = {
    _id: 'fake-board',
    name: 'TEST â€“ ' + pedalId,
    pedals: [
      {
        pedal_id: pedal._id,
        row: 1,
        rotation: 0
      }
    ]
  };

  // Render pedalboard
  try {
    await renderFullPedalboard(fakeBoard);
    resultsDiv.innerHTML = ''; // pulisci messaggio caricamento
    resultsDiv.appendChild(document.getElementById('preset')); // aggiungi il container pedalboard
  } catch (err) {
    console.error(err);
    resultsDiv.innerHTML = 'Errore nel render: ' + err.message;
  }

})();
</script>

<!-- Container necessario per renderFullPedalboard -->
<div id="preset"></div>

</body>
</html>
