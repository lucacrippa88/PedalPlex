<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Test Single Pedal Auth</title>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="utils.js"></script> <!-- renderFullPedalboard + helpers -->
<style>
  body { font-family:sans-serif; padding:20px; }
  #results { margin-top: 20px; border: 1px solid #ccc; padding: 10px; min-height: 200px; }
</style>
</head>
<body>

<h1>TEST PEDALBOARD SINGLE PEDAL MODE (Auth)</h1>
<div id="results">Caricamento pedalboard...</div>

<script>
(async function() {

  const resultsDiv = document.getElementById('results');
  window.resultsDiv = resultsDiv;

  const pedalId = new URLSearchParams(window.location.search).get('id');
  if (!pedalId) {
    resultsDiv.innerHTML = 'Nessun pedale selezionato. Usa ?id=<PEDAL_ID>';
    return;
  }

  const token = localStorage.getItem("authToken");
  if (!token) {
    resultsDiv.innerHTML = 'Nessun authToken trovato in localStorage. Effettua login prima.';
    return;
  }

  // Funzione fetch pedale
  async function fetchPedalById(id) {
    try {
      const res = await fetch('https://www.cineteatrosanluigi.it/plex/GET_PEDALS_BY_IDS.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ ids: [id] })
      });

      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      if (!data.docs || data.docs.length === 0) return null;
      return data.docs[0];

    } catch (err) {
      console.error("Errore fetching pedal:", err);
      return null;
    }
  }

  // Funzione fetch SubPlex
  async function fetchSubplexes(pedalId) {
    try {
      const res = await fetch('https://www.cineteatrosanluigi.it/plex/GET_PRESETS_BY_PEDAL.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ pedalId })
      });

      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      return data.presets || [];
    } catch(err) {
      console.error("Errore fetching SubPlex:", err);
      return [];
    }
  }

  resultsDiv.innerHTML = 'Recupero pedale dal server...';

  // 1️⃣ Recupera pedale principale
  const pedalDoc = await fetchPedalById(pedalId);
  if (!pedalDoc) {
    resultsDiv.innerHTML = 'Pedale non trovato: ' + pedalId;
    return;
  }

  // 2️⃣ Recupera eventuali SubPlex
  const subplexDocs = await fetchSubplexes(pedalId);

  // 3️⃣ Inizializza catalogMap
  window.catalogMap = {};
  window.catalogMap[pedalId] = pedalDoc;
  subplexDocs.forEach(sp => { window.catalogMap[sp._id] = sp; });

  // 4️⃣ Crea pedalboard fake
  const fakeBoard = {
    _id: 'fake-board',
    name: 'TEST – ' + pedalId,
    pedals: [
      {
        pedal_id: pedalId,
        row: 1,
        rotation: 0,
        subplex: subplexDocs.map(sp => ({ pedal_id: sp._id }))
      }
    ]
  };

  resultsDiv.innerHTML = 'Rendering pedalboard...';

  try {
    await renderFullPedalboard(fakeBoard);
    resultsDiv.innerHTML = ''; // pulisci messaggio di caricamento
  } catch (err) {
    console.error(err);
    resultsDiv.innerHTML = 'Errore nel render: ' + err.message;
  }

})();
</script>

</body>
</html>
