<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PedalPlex – Test Single Pedal</title>

<link rel="stylesheet" href="css/carbon-components.min.css" />
<link rel="stylesheet" href="css/style.css" />

<script src="https://unpkg.com/carbon-components/scripts/carbon-components.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  body { font-family: sans-serif; padding: 20px; }
  #results { margin-top: 20px; color: #c00; }
  #pedalboard { width: 100%; min-height: 300px; }
</style>
</head>

<body>

<!-- LOADER -->
<div class="bx--loading-overlay" id="pageLoader" style="display:none;">
  <div class="bx--loading" role="status">
    <svg class="bx--loading__svg" viewBox="-75 -75 150 150">
      <circle class="bx--loading__background" cx="0" cy="0" r="37.5"/>
      <circle class="bx--loading__stroke" cx="0" cy="0" r="37.5"/>
    </svg>
  </div>
</div>

<!-- CONTENT -->
<div id="page-content">
  <div id="pedalboard"></div>
  <div id="results"></div>
</div>

<!-- SCRIPT CORE -->
<script src="utils.js"></script>
<script src="fullscreen-menu.js"></script>
<script src="nav.js"></script>
<script src="zoom.js"></script>

<script>
(async function () {

  const resultsDiv = document.getElementById('results');
  window.resultsDiv = resultsDiv;

  /* ================= LOGIN ================= */

  async function doLogin(username, password) {
    const res = await fetch('https://www.cineteatrosanluigi.it/plex/USER_LOGIN.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    if (!res.ok) throw new Error('Login failed');
    const data = await res.json();
    localStorage.setItem('authToken', data.token);
    return data.user;
  }

  let token = localStorage.getItem('authToken');

  if (token) {
    try {
      const res = await fetch('https://www.cineteatrosanluigi.it/plex/USER_CHECK_AUTH_JWT.php', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) throw new Error();
      window.currentUser = await res.json();
    } catch {
      localStorage.removeItem('authToken');
      token = null;
    }
  }

  if (!token) {
    const { value } = await Swal.fire({
      title: 'Login',
      html:
        '<input id="u" class="swal2-input" placeholder="Username">' +
        '<input id="p" type="password" class="swal2-input" placeholder="Password">',
      preConfirm: () => [
        document.getElementById('u').value,
        document.getElementById('p').value
      ]
    });
    if (!value) return;
    await doLogin(value[0], value[1]);
    token = localStorage.getItem('authToken');
  }

  /* ================= PEDALE ================= */

  const pedalId = new URLSearchParams(location.search).get('id');
  if (!pedalId) {
    resultsDiv.textContent = 'Usa ?id=<PEDAL_ID>';
    return;
  }

  async function fetchPedals(ids) {
    try {
      const res = await fetch('https://www.cineteatrosanluigi.it/plex/GET_PEDALS_BY_IDS.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ ids })
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      return data.docs || [];
    } catch (err) {
      console.error('[TEST-PLEX] Error fetching pedals:', err);
      resultsDiv.textContent = 'Errore nel fetch del pedale: ' + err.message;
      return [];
    }
  }

  async function fetchPresetsByPedal(pedalId) {
    try {
      const res = await fetch('https://www.cineteatrosanluigi.it/plex/GET_PRESETS_BY_PEDAL.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ pedal_id: pedalId })
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      return data.docs || [];
    } catch (err) {
      console.error('[TEST-PLEX] Error fetching presets:', err);
      return [];
    }
  }

  // Fetch pedale principale
  const [pedal] = await fetchPedals([pedalId]);
  if (!pedal) {
    resultsDiv.textContent = 'Pedale non trovato';
    return;
  }

  // Fetch subplex
  let subplexDocs = [];
  if (pedal.subplex?.length) {
    subplexDocs = await fetchPedals(pedal.subplex.map(s => s.pedal_id));
  }

  // Fetch presets
  const presets = await fetchPresetsByPedal(pedalId);
  pedal.presets = presets;

  // Catalog globale
  window.catalogMap = {};
  window.catalogMap[pedalId] = pedal;
  subplexDocs.forEach(p => window.catalogMap[p._id] = p);

  /* ================= FAKE BOARD ================= */

  const fakeBoard = {
    _id: 'test-board',
    name: 'TEST – ' + pedalId,
    pedals: [{
      pedal_id: pedalId,
      row: 1,
      rotation: 0,
      subplex: pedal.subplex || []
    }]
  };

  /* ================= RENDER ================= */

  try {
    await renderFullPedalboard(fakeBoard);
  } catch (err) {
    console.error('Errore render:', err);
    resultsDiv.textContent = 'Errore nel render: ' + err.message;
  }

})();
</script>

</body>
</html>
