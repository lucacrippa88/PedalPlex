<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PedalPlex</title>
  <!-- Anticipate Carbon Design load -->
  <link rel="dns-prefetch" href="https://1.www.s81c.com">
  <link rel="preconnect" href="https://1.www.s81c.com" crossorigin>
  <link rel="stylesheet" href="css/carbon-components.min.css" />
  <script src="https://unpkg.com/carbon-components/scripts/carbon-components.min.js"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BX9P5WN5HH"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-BX9P5WN5HH');
  </script>

  <link rel="stylesheet" href="css/style.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
  
  <div id="page-content" style="display: none;">

    <select id="categoryFilter">
      <option value="all" selected>All categories</option>
      <option value="acoustic">Acoustic</option>
      <option value="ambient">Ambient</option>
      <option value="ampli">Amplifier</option>
      <option value="boost">Boost</option>
      <option value="chorus">Chorus</option>
      <option value="compressor">Compressor/Sustainer</option>
      <option value="delay">Delay/Echo</option>
      <option value="distortion">Distortion/Overdrive</option>
      <option value="drup">Drum sequencer/Pad</option>
      <option value="eq">Equalizer/Filter</option>
      <option value="expression">Expression/Volume/Swell</option>
      <option value="flanger">Flanger</option>
      <option value="fuzz">Fuzz/Muff</option>
      <option value="looper">Looper</option>
      <option value="modulation">Modulation</option>
      <option value="multifx">Multi FX</option>
      <option value="octaver">Octaver</option>
      <option value="phaser">Phaser</option>
      <option value="pitchshifter">Pitch Shifter</option>
      <option value="preamp">Preamp/IR Loader</option>
      <option value="reverb">Reverb/Shimmer</option>
      <option value="vibrato">Vibrato/Tremolo/Rotary</option>
      <option value="synth">Synth/Sampler/Bit Crusher</option>
      <option value="utility">Utility (Buffer/Tuner/DI/Noise Gate)</option>
      <option value="vocoder">Vocoder/Talk Box</option>
      <option value="wah">Wah</option>
    </select>

    <a href="pedalboard" class="showDesktop bx--btn bx--btn--primary" type="button" style="margin-left: auto!important; max-width:500px!important;">Back to Pedalboards
      <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" class="bx--btn__icon">
        <path d="M14 26L15.41 24.59 7.83 17 28 17 28 15 7.83 15 15.41 7.41 14 6 4 16 14 26z"/>
      </svg>   
    </a>  

    <div id="catalog"></div>

    <!-- Load scripts after content is visible -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="utils.js"></script>
    <script src="catalog.js"></script>
    <script src="fullscreen-menu.js"></script>
    <script src="nav-catalog.js"></script>
  </div>

  <script>
  // Check user authentication
  $(document).ready(function() {
  if (window.location.protocol === 'file:') {
    alert('Please run this app via a local HTTP server for full functionality.');
    $('#loadingMessage').hide();
    $('#page-content').hide();
    return;
  }

  const token = localStorage.getItem('authToken');

  if (!token) {
    // Guest mode
    $('#loadingMessage').hide();
    $('#page-content').show();

    window.currentUser = { role: 'guest' };

    if (typeof initNavCatalog === 'function') initNavCatalog('guest');
    if (typeof initCatalog === 'function') initCatalog('guest');

    return;
  }

  // Existing auth check
  $.ajax({
    url: 'https://www.cineteatrosanluigi.it/plex/USER_CHECK_AUTH_JWT.php',
    method: 'GET',
    dataType: 'json',
    headers: { 'Authorization': 'Bearer ' + token },
    success: function(userFromServer) {
      $('#loadingMessage').hide(); 
      $('#page-content').show();

      window.currentUser = userFromServer;

      if (typeof initNavCatalog === 'function') initNavCatalog(userFromServer.role);
      if (typeof initCatalog === 'function') initCatalog(userFromServer.role);
    },
    error: function(xhr) {
      console.error('Auth check failed:', xhr.status, xhr.responseText);
      if (xhr.status === 401) {
        localStorage.removeItem('authToken');
        window.location.href = '';
      } else {
        alert('Failed to verify authentication. Please try again.');
      }
    }
  });
});

</script>


</body>
</html>
