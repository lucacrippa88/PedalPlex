<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PedalPlex</title>
  <link rel="icon" href="logos/pedalplex_logo_gradient.png" type="image/x-icon">
  <link rel="stylesheet" href="css/carbon-components.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <div id="page-content">
    
    <h2>Change Password</h2><br><br>
    <form id="changePasswordForm" style="max-width: 400px; margin: auto;">
      <!-- Old Password -->
      <div style="position: relative; margin-bottom: 10px;">
        <input type="password" id="oldPassword" placeholder="Old Password" required class="bx--text-input"
            style="width: 100%;" />
        <button type="button" id="togglePasswordOld" aria-label="Show password" 
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">
            <svg xmlns="http://www.w3.org/2000/svg" class="bx--icon" width="20" height="20" fill="currentColor" viewBox="0 0 32 32">
            <path d="M16,10a6,6,0,1,1-6,6A6,6,0,0,1,16,10Zm0-2C10.5,8,5.8,12,4,16c1.8,4,6.5,8,12,8s10.2-4,12-8C26.2,12,21.5,8,16,8Z"/>
          </svg>
        </button>
      </div>

      <!-- New Password -->
      <div style="position: relative; margin-bottom: 10px;">
        <input type="password" id="newPassword" placeholder="New Password" required class="bx--text-input"
            style="width: 100%;" />
        <button type="button" id="togglePasswordNew" aria-label="Show password" 
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">
            <svg xmlns="http://www.w3.org/2000/svg" class="bx--icon" width="20" height="20" fill="currentColor" viewBox="0 0 32 32">
            <path d="M16,10a6,6,0,1,1-6,6A6,6,0,0,1,16,10Zm0-2C10.5,8,5.8,12,4,16c1.8,4,6.5,8,12,8s10.2-4,12-8C26.2,12,21.5,8,16,8Z"/>
          </svg>
        </button>
      </div>

      <br>

      <button class="bx--btn bx--btn--primary" type="submit" style="width: 100%;">Change Password</button>
    </form>

    <br><br>
    <h2>Link Google Account</h2><br><br>
    <button id="linkGoogleBtn" class="bx--btn bx--btn--secondary" style="width: 100%;">
      Link
    </button>


    <br><br>
    <div id="admin-dashboard">
    <h2>Admin Dashboard</h2>

    <div class="bx--grid">
      <div class="bx--row">
        <div class="bx--col"><strong>Gear Public:</strong> <span id="g-public">–</span></div>
        <div class="bx--col"><strong>Private:</strong> <span id="g-private">–</span></div>
        <div class="bx--col"><strong>Reviewing:</strong> <span id="g-reviewing">–</span></div>
        <div class="bx--col"><strong>Draft:</strong> <span id="g-draft">–</span></div>
      </div>
      <br>
      <div class="bx--row">
        <div class="bx--col"><strong>Users:</strong> <span id="c-users">–</span></div>
        <div class="bx--col"><strong>Rigs:</strong> <span id="c-rigs">–</span></div>
        <div class="bx--col"><strong>Plexes:</strong> <span id="c-plexes">–</span></div>
        <div class="bx--col"><strong>SubPlexes:</strong> <span id="c-subplexes">–</span></div>
      </div>
    </div>
  </div>


  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="fullscreen-menu.js"></script>
  <script src="nav.js"></script>

  <script>
  // Check user authentication
  $(document).ready(function() {
    if (window.location.protocol === 'file:') {
      alert('Please run this app via a local HTTP server for full functionality.');
      $('#page-content').hide();
      return;
    }

    const token = localStorage.getItem('authToken');
    if (!token) {
      window.location.href = 'login';
      return;
    }

    $.ajax({
      url: 'https://api.pedalplex.com/USER_CHECK_AUTH_JWT.php',
      method: 'GET',
      dataType: 'json',
      headers: { 'Authorization': 'Bearer ' + token },
      success: function(userFromServer) {
        $('#page-content').show();
        window.currentUser = userFromServer;
        // If admin, load dashboard stats
        loadAdminStats();
      },
      error: function(xhr) {
        if (xhr.status === 401) {
          localStorage.removeItem('authToken');
          window.location.href = 'login';
        } else {
          alert('Failed to verify authentication.');
        }
      }
    });
  });
  </script>

  <script>
    // Toggle password visibility
    const toggleOld = document.getElementById('togglePasswordOld');
    const toggleNew = document.getElementById('togglePasswordNew');
    const oldInput = document.getElementById('oldPassword');
    const newInput = document.getElementById('newPassword');

    toggleOld.addEventListener('click', () => { oldInput.type = oldInput.type === 'password' ? 'text' : 'password'; });
    toggleNew.addEventListener('click', () => { newInput.type = newInput.type === 'password' ? 'text' : 'password'; });

    // Change password form submission
    $('#changePasswordForm').submit(function (e) {
      e.preventDefault();
      const token = localStorage.getItem('authToken');

      $.ajax({
        url: 'https://api.pedalplex.com/USER_CHANGE_PASSWORD.php',
        type: 'POST',
        contentType: 'application/json',
        headers: { 'Authorization': 'Bearer ' + token },
        data: JSON.stringify({
          oldPassword: $('#oldPassword').val(),
          newPassword: $('#newPassword').val()
        }),
        success: function () {
          Swal.fire({ title: 'Password changed!', icon: 'success', timer: 2000, showConfirmButton: false });
          setTimeout(() => window.location.reload(), 2000);
        },
        error: function (res) {
          let errorMsg = "Unknown error";
          try { const json = JSON.parse(res.responseText); errorMsg = json.error || errorMsg; } catch(e){ }
          Swal.fire({ icon: 'error', title: 'Change Failed', text: errorMsg });
        }
      });
    });

    // Google linking
    document.getElementById('linkGoogleBtn').addEventListener('click', () => {
      google.accounts.id.initialize({
        client_id: '760340498879-qkpjocfkd0204ihu0qdmaaegr5bdp6gj.apps.googleusercontent.com',
        callback: handleGoogleLink
      });
      google.accounts.id.prompt(); // mostra il popup
    });

    function handleGoogleLink(response) {
      const id_token = response.credential;
      const token = localStorage.getItem('authToken'); // JWT utente

      $.ajax({
        url: 'https://api.pedalplex.com/USER_LINK_GOOGLE.php',
        type: 'POST',
        contentType: 'application/json',
        headers: { 'Authorization': 'Bearer ' + token },
        data: JSON.stringify({ id_token }),
        success: function(res){
          if(res.success){
            Swal.fire('Linked!', 'Your Google account has been linked.', 'success');
          } else {
            Swal.fire('Error', res.error || 'Impossible to link Google account. Please retry later.', 'error');
          }
        },
        error: function(){
          Swal.fire('Server error', 'Retry later.', 'error');
        }
      });
    }
  </script>


<script>
function loadAdminStats() {
  if (!window.currentUser || window.currentUser.role !== 'admin') return;

  $('#admin-dashboard').show();

  $.ajax({
    url: 'https://api.pedalplex.com/ADMIN_DASHBOARD_STATS.php',
    method: 'GET',
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('authToken')
    },
    success: function (d) {
      $('#g-public').text(d.gears.public);
      $('#g-private').text(d.gears.private);
      $('#g-reviewing').text(d.gears.reviewing);
      $('#g-draft').text(d.gears.draft);

      $('#c-plexes').text(d.plexes);
      $('#c-subplexes').text(d.subplexes);
      $('#c-users').text(d.users);
      $('#c-rigs').text(d.rigs);
    },
    error: function () {
      Swal.fire('Error', 'Failed to load admin stats', 'error');
    }
  });
}

// dopo USER_CHECK_AUTH_JWT success
// aggiungi:
// loadAdminStats();
</script>


</body>
</html>
